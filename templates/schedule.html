{% extends "base.html" %}
{% block title %}Scheduled Posts | PodInsights{% endblock %}
{% block header %}Scheduled Posts{% endblock %}
{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Scheduled Posts</li>
    </ol>
</nav>

<!-- Social Connections -->
<div class="row mb-4">
    <!-- LinkedIn Connection Status -->
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #0077B5 0%, #005885 100%); color: white;">
                <strong>üíº LinkedIn</strong>
                <span id="linkedin-status-badge" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body">
                <div id="linkedin-status-content">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span>Checking connection...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Threads Connection Status -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #000000 0%, #333333 100%); color: white;">
                <strong>üßµ Threads</strong>
                <span id="threads-status-badge" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body">
                <div id="threads-status-content">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-dark me-2" role="status"></div>
                        <span>Checking connection...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Slots Configuration -->
<div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#timeSlotsCollapse" style="cursor: pointer;">
        <strong>üïê Posting Schedule (Time Slots)</strong>
        <span class="badge bg-info">{{ time_slots|length }} slot{% if time_slots|length != 1 %}s{% endif %}</span>
    </div>
    <div class="collapse show" id="timeSlotsCollapse">
        <div class="card-body">
            <div class="alert alert-info mb-3" id="next-slots-container">
                <div class="d-flex justify-content-between align-items-start">
                    <strong>üìå Next available slots by platform:</strong>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshNextSlots()" title="Refresh">
                        üîÑ
                    </button>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <span class="badge" style="background-color: #0077B5;">üíº LinkedIn</span>
                        <span id="next-slot-linkedin">
                            {% if next_slots and next_slots.linkedin %}
                            {{ next_slots.linkedin }}
                            {% else %}
                            <span class="text-muted">No slots available</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <span class="badge bg-dark">üßµ Threads</span>
                        <span id="next-slot-threads">
                            {% if next_slots and next_slots.threads %}
                            {{ next_slots.threads }}
                            {% else %}
                            <span class="text-muted">No slots available</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <p class="text-muted mb-3">
                Configure your posting times. When you "Add to Queue" from an article, posts will be automatically scheduled for the next available time slot.
            </p>
            
            <!-- Add New Slot Form -->
            <form id="addSlotForm" class="row g-2 mb-3">
                <div class="col-md-4">
                    <select name="day_of_week" class="form-select form-select-sm" id="newSlotDay">
                        <option value="-1">Every day</option>
                        <option value="0">Monday</option>
                        <option value="1">Tuesday</option>
                        <option value="2">Wednesday</option>
                        <option value="3">Thursday</option>
                        <option value="4">Friday</option>
                        <option value="5">Saturday</option>
                        <option value="6">Sunday</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="time" name="time_slot" class="form-control form-control-sm" id="newSlotTime" required>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-sm btn-primary w-100">
                        <i class="bi bi-plus"></i> Add Time Slot
                    </button>
                </div>
            </form>
            
            <!-- Existing Slots -->
            <div id="timeSlotsContainer">
                {% if time_slots %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for slot in time_slots %}
                            <tr id="slot-row-{{ slot.id }}">
                                <td>{{ slot.day_display }}</td>
                                <td>{{ slot.time_slot }}</td>
                                <td>
                                    {% if slot.enabled %}
                                    <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Disabled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-xs btn-outline-primary" onclick="openEditSlotModal({{ slot.id }}, {{ slot.day_of_week }}, '{{ slot.time_slot }}')" title="Edit">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn btn-xs btn-outline-secondary" onclick="toggleSlot({{ slot.id }})" title="Toggle">
                                        {% if slot.enabled %}‚è∏Ô∏è{% else %}‚ñ∂Ô∏è{% endif %}
                                    </button>
                                    <button class="btn btn-xs btn-outline-danger" onclick="deleteSlot({{ slot.id }})" title="Delete">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3 text-muted">
                    <small>No time slots configured. Add your first posting time above.</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Daily Posting Limits -->
<div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#dailyLimitsCollapse" style="cursor: pointer;">
        <strong>üìä Daily Posting Limits</strong>
        <span class="badge bg-secondary">Per Platform</span>
    </div>
    <div class="collapse show" id="dailyLimitsCollapse">
        <div class="card-body">
            <p class="text-muted mb-3">
                Set the maximum number of posts that can be scheduled per day for each platform. Set to 0 for unlimited posts.
            </p>
            
            <div class="row g-3">
                <!-- LinkedIn Limit -->
                <div class="col-md-6">
                    <div class="card h-100" style="border-left: 4px solid #0077B5;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold">üíº LinkedIn</span>
                                <span class="badge bg-info" id="linkedin-limit-badge">
                                    {{ daily_limits.get('linkedin', 0) or 'Unlimited' }}{% if daily_limits.get('linkedin', 0) %}/day{% endif %}
                                </span>
                            </div>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="linkedin-limit-input" 
                                       value="{{ daily_limits.get('linkedin', 0) }}" min="0" 
                                       placeholder="0 = unlimited">
                                <button class="btn btn-outline-primary" type="button" onclick="updateDailyLimit('linkedin')">
                                    Save
                                </button>
                            </div>
                            <small class="text-muted">0 = no limit</small>
                        </div>
                    </div>
                </div>
                
                <!-- Threads Limit -->
                <div class="col-md-6">
                    <div class="card h-100" style="border-left: 4px solid #000000;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold">üßµ Threads</span>
                                <span class="badge bg-dark" id="threads-limit-badge">
                                    {{ daily_limits.get('threads', 0) or 'Unlimited' }}{% if daily_limits.get('threads', 0) %}/day{% endif %}
                                </span>
                            </div>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="threads-limit-input" 
                                       value="{{ daily_limits.get('threads', 0) }}" min="0" 
                                       placeholder="0 = unlimited">
                                <button class="btn btn-outline-dark" type="button" onclick="updateDailyLimit('threads')">
                                    Save
                                </button>
                            </div>
                            <small class="text-muted">0 = no limit</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar mb-4">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label">Status Filter</label>
            <select name="status" class="form-select" onchange="this.form.submit()">
                <option value="">All Statuses</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>‚è≥ Pending</option>
                <option value="posted" {% if status_filter == 'posted' %}selected{% endif %}>‚úÖ Posted</option>
                <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>‚ùå Failed</option>
                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>üö´ Cancelled</option>
            </select>
        </div>
        <div class="col-md-2">
            <a href="{{ url_for('schedule_list') }}" class="btn btn-outline-secondary w-100">Clear Filter</a>
        </div>
    </form>
</div>

<!-- Scheduled Posts Table -->
<div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <strong>üìÖ Scheduled Posts Queue</strong>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary">{{ scheduled_posts|length }} post{% if scheduled_posts|length != 1 %}s{% endif %}</span>
            <button class="btn btn-sm btn-outline-danger d-none" id="delete-selected-btn" onclick="deleteSelected()">
                üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="clearQueue()" title="Clear all pending posts">
                üóëÔ∏è Clear Pending
            </button>
        </div>
    </div>
    <div class="card-body">
        {% if scheduled_posts %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" class="form-check-input" id="select-all" onchange="toggleSelectAll(this)">
                        </th>
                        <th>Status</th>
                        <th>Scheduled For</th>
                        <th>Type</th>
                        <th>Content Preview</th>
                        <th>Platform</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for post in scheduled_posts %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input post-checkbox" 
                                   data-post-id="{{ post.id }}" onchange="updateSelectedCount()">
                        </td>
                        <td>
                            {% if post.status == 'pending' %}
                            <span class="badge bg-warning text-dark">‚è≥ Pending</span>
                            {% elif post.status == 'posted' %}
                            <span class="badge bg-success">‚úÖ Posted</span>
                            {% elif post.status == 'failed' %}
                            <span class="badge bg-danger" title="{{ post.error_message or '' }}">‚ùå Failed</span>
                            {% elif post.status == 'cancelled' %}
                            <span class="badge bg-secondary">üö´ Cancelled</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ post.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span title="{{ post.scheduled_for }}">
                                {{ post.scheduled_for_display or post.scheduled_for }}
                            </span>
                            {% if post.posted_at %}
                            <br><small class="text-muted">Posted: {{ post.posted_at }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if post.post_type == 'social' %}
                            <span class="badge bg-info">Social Post</span>
                            {% elif post.post_type == 'article' %}
                            <span class="badge bg-primary">Article</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ post.post_type }}</span>
                            {% endif %}
                        </td>
                        <td class="description-cell" style="max-width: 300px;">
                            {% if post.social_content %}
                            {{ post.social_content[:100] }}{% if post.social_content|length > 100 %}...{% endif %}
                            {% elif post.standalone_content %}
                            {{ post.standalone_content[:100] }}{% if post.standalone_content|length > 100 %}...{% endif %}
                            {% elif post.article_topic %}
                            <strong>{{ post.article_topic }}</strong>
                            {% else %}
                            <span class="text-muted">No content preview</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if post.platform == 'linkedin' %}
                            <span class="badge" style="background-color: #0077B5;">üíº LinkedIn</span>
                            {% elif post.platform == 'threads' %}
                            <span class="badge" style="background-color: #000000;">üßµ Threads</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ post.platform }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if post.status == 'pending' %}
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal({{ post.id }}, '{{ post.scheduled_for }}')" title="Edit Time">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-sm btn-success" onclick="postNow({{ post.id }}, '{{ post.platform }}')" title="Post Now">
                                üöÄ Post Now
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="cancelPost({{ post.id }})" title="Cancel">
                                üö´ Cancel
                            </button>
                            {% elif post.status == 'posted' and post.linkedin_post_urn %}
                                {% if post.platform == 'threads' %}
                                    {% if post.linkedin_post_urn.startswith('http') %}
                                    <a href="{{ post.linkedin_post_urn }}" 
                                       target="_blank" class="btn btn-sm btn-outline-dark" title="View on Threads">
                                        üîó View
                                    </a>
                                    {% else %}
                                    <span class="text-muted small">No view link</span>
                                    {% endif %}
                                {% else %}
                                <a href="https://www.linkedin.com/feed/update/{{ post.linkedin_post_urn }}" 
                                   target="_blank" class="btn btn-sm btn-outline-primary" title="View on LinkedIn">
                                    üîó View
                                </a>
                                {% endif %}
                            {% elif post.status == 'failed' %}
                            <button class="btn btn-sm btn-outline-success" onclick="retryPost({{ post.id }})" title="Retry Posting">
                                üîÑ Retry
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePost({{ post.id }})" title="Delete">
                                üóëÔ∏è Delete
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showError('{{ post.error_message|e }}')" title="Show Error">
                                ‚ÑπÔ∏è Error
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePost({{ post.id }})" title="Delete">
                                üóëÔ∏è Delete
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <div style="font-size: 3rem;">üìÖ</div>
            <h5 class="mt-3">No scheduled posts</h5>
            <p>Schedule posts from the article page to see them here.</p>
            <a href="{{ url_for('view_articles') }}" class="btn btn-primary">View Articles</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Error Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="errorContent" class="mb-0" style="white-space: pre-wrap;"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #0077B5 0%, #005885 100%); color: white;">
                <h5 class="modal-title">‚úèÔ∏è Edit Scheduled Time</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-post-id">
                <div class="mb-3">
                    <label class="form-label">New Scheduled Time</label>
                    <input type="datetime-local" class="form-control" id="edit-datetime" required>
                </div>
                <div class="alert alert-info mb-0">
                    <small>
                        <strong>üí° Tip:</strong> You can also use the time slots. The next available slot is shown on the Schedule page.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEdit()">
                    üíæ Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Time Slot Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">‚úèÔ∏è Edit Time Slot</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-slot-id">
                <div class="mb-3">
                    <label class="form-label">Day of Week</label>
                    <select class="form-select" id="edit-slot-day">
                        <option value="-1">Every day</option>
                        <option value="0">Monday</option>
                        <option value="1">Tuesday</option>
                        <option value="2">Wednesday</option>
                        <option value="3">Thursday</option>
                        <option value="4">Friday</option>
                        <option value="5">Saturday</option>
                        <option value="6">Sunday</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Time</label>
                    <input type="time" class="form-control" id="edit-slot-time" required>
                </div>
                <div class="alert alert-info mb-0">
                    <small>
                        <strong>üí° Note:</strong> Editing this slot will automatically redistribute all pending posts to use the optimal schedule.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSlotEdit()">
                    üíæ Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Check connection status on load
document.addEventListener('DOMContentLoaded', function() {
    checkLinkedInStatus();
    checkThreadsStatus();
    // Auto-refresh next slots to ensure they're current
    refreshNextSlots();
});

// Refresh next available slots display
function refreshNextSlots() {
    const linkedinSpan = document.getElementById('next-slot-linkedin');
    const threadsSpan = document.getElementById('next-slot-threads');
    
    // Show loading state
    if (linkedinSpan) linkedinSpan.innerHTML = '<span class="text-muted">Loading...</span>';
    if (threadsSpan) threadsSpan.innerHTML = '<span class="text-muted">Loading...</span>';
    
    // Fetch LinkedIn next slot
    fetch('/schedule/next-slot?platform=linkedin')
        .then(response => response.json())
        .then(data => {
            if (linkedinSpan) {
                if (data.next_slot_display) {
                    linkedinSpan.textContent = data.next_slot_display;
                } else {
                    linkedinSpan.innerHTML = '<span class="text-muted">No slots available</span>';
                }
            }
        })
        .catch(() => {
            if (linkedinSpan) linkedinSpan.innerHTML = '<span class="text-muted">Error loading</span>';
        });
    
    // Fetch Threads next slot
    fetch('/schedule/next-slot?platform=threads')
        .then(response => response.json())
        .then(data => {
            if (threadsSpan) {
                if (data.next_slot_display) {
                    threadsSpan.textContent = data.next_slot_display;
                } else {
                    threadsSpan.innerHTML = '<span class="text-muted">No slots available</span>';
                }
            }
        })
        .catch(() => {
            if (threadsSpan) threadsSpan.innerHTML = '<span class="text-muted">Error loading</span>';
        });
}

function checkLinkedInStatus() {
    fetch('{{ url_for("linkedin_status") }}')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('linkedin-status-badge');
            const content = document.getElementById('linkedin-status-content');
            
            if (data.connected && data.needs_configuration) {
                // Connected but needs member ID configuration
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Needs Setup';
                content.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>‚ö†Ô∏è Configuration Required</strong><br>
                                <small>Your LinkedIn account is connected, but you need to configure your Member ID to post.</small>
                            </div>
                            <div class="ms-3">
                                <a href="${data.configure_url || '{{ url_for("linkedin_configure") }}'}" class="btn btn-warning btn-sm">
                                    Configure Now
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.connected) {
                badge.className = 'badge bg-success';
                badge.textContent = 'Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${data.display_name || 'LinkedIn User'}</strong>
                            ${data.email ? '<br><small class="text-muted">' + data.email + '</small>' : ''}
                            ${data.user_urn ? '<br><small class="text-muted font-monospace">' + data.user_urn + '</small>' : ''}
                        </div>
                        <div>
                            <a href="{{ url_for('linkedin_configure') }}" class="btn btn-sm btn-outline-secondary me-2">
                                Configure
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="disconnectLinkedIn()">
                                Disconnect
                            </button>
                        </div>
                    </div>
                `;
            } else if (data.configured) {
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Not Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${data.message || 'Click to connect your LinkedIn account'}</span>
                        <a href="{{ url_for('linkedin_auth') }}" class="btn btn-primary">
                            Connect LinkedIn
                        </a>
                    </div>
                `;
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Not Configured';
                content.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <strong>LinkedIn Not Configured</strong><br>
                        <small>${data.message || 'Set LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET environment variables.'}</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error checking LinkedIn status:', error);
            document.getElementById('linkedin-status-badge').textContent = 'Error';
            document.getElementById('linkedin-status-content').innerHTML = 
                '<span class="text-danger">Failed to check LinkedIn status</span>';
        });
}

function disconnectLinkedIn() {
    if (!confirm('Are you sure you want to disconnect LinkedIn?')) return;
    
    fetch('{{ url_for("linkedin_disconnect") }}', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkLinkedInStatus();
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

// Check Threads connection status
function checkThreadsStatus() {
    fetch('{{ url_for("threads_status") }}')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('threads-status-badge');
            const content = document.getElementById('threads-status-content');
            
            if (data.connected) {
                badge.className = 'badge bg-success';
                badge.textContent = 'Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            ${data.profile_picture_url ? '<img src="' + data.profile_picture_url + '" class="rounded-circle me-2" width="40" height="40" alt="">' : ''}
                            <div>
                                <strong>@${data.username || 'Threads User'}</strong>
                                ${data.display_name && data.display_name !== data.username ? '<br><small class="text-muted">' + data.display_name + '</small>' : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="disconnectThreads()">
                            Disconnect
                        </button>
                    </div>
                `;
            } else if (data.configured) {
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Not Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${data.message || 'Click to connect your Threads account'}</span>
                        <a href="{{ url_for('threads_auth') }}" class="btn btn-dark">
                            Connect Threads
                        </a>
                    </div>
                `;
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Not Configured';
                content.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <strong>Threads Not Configured</strong><br>
                        <small>${data.message || 'Set THREADS_APP_ID and THREADS_APP_SECRET environment variables.'}</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error checking Threads status:', error);
            document.getElementById('threads-status-badge').textContent = 'Error';
            document.getElementById('threads-status-content').innerHTML = 
                '<span class="text-danger">Failed to check Threads status</span>';
        });
}

function disconnectThreads() {
    if (!confirm('Are you sure you want to disconnect Threads?')) return;
    
    fetch('{{ url_for("threads_disconnect") }}', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkThreadsStatus();
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function postNow(postId, platform) {
    if (!confirm(`Post this ${platform} content immediately?`)) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Posting...';
    
    fetch(`/schedule/${postId}/post-now`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.innerHTML = '‚úÖ Posted!';
                btn.className = 'btn btn-sm btn-success';
                setTimeout(() => location.reload(), 1500);
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert(data.error || 'Failed to post');
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('Error: ' + error.message);
        });
}

function cancelPost(postId) {
    if (!confirm('Cancel this scheduled post?')) return;
    
    fetch(`/schedule/${postId}/cancel`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to cancel post');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function deletePost(postId) {
    if (!confirm('Delete this scheduled post?')) return;
    
    fetch(`/schedule/${postId}/delete`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to delete post');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function retryPost(postId) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Retrying...';
    btn.disabled = true;
    
    fetch(`/schedule/${postId}/retry`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Post successful!');
                location.reload();
            } else {
                alert(data.error || 'Retry failed');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function clearQueue() {
    if (!confirm('Clear ALL pending posts from the queue? This cannot be undone.')) return;
    
    fetch('/schedule/clear-queue', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.error || 'Failed to clear queue');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.post-checkbox:checked');
    const count = checkboxes.length;
    const countSpan = document.getElementById('selected-count');
    const deleteBtn = document.getElementById('delete-selected-btn');
    const selectAll = document.getElementById('select-all');
    
    countSpan.textContent = count;
    
    if (count > 0) {
        deleteBtn.classList.remove('d-none');
    } else {
        deleteBtn.classList.add('d-none');
    }
    
    // Update select-all checkbox state
    const allCheckboxes = document.querySelectorAll('.post-checkbox');
    if (allCheckboxes.length > 0) {
        selectAll.checked = count === allCheckboxes.length;
        selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
    }
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.post-checkbox:checked');
    const postIds = Array.from(checkboxes).map(cb => cb.dataset.postId);
    
    if (postIds.length === 0) {
        alert('No posts selected');
        return;
    }
    
    if (!confirm(`Delete ${postIds.length} selected post${postIds.length !== 1 ? 's' : ''}? This cannot be undone.`)) return;
    
    fetch('/schedule/delete-selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_ids: postIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'Failed to delete posts');
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function showError(errorMessage) {
    document.getElementById('errorContent').textContent = errorMessage || 'No error details available';
    new bootstrap.Modal(document.getElementById('errorModal')).show();
}

function openEditModal(postId, currentScheduledFor) {
    document.getElementById('edit-post-id').value = postId;
    
    // Convert ISO datetime to local datetime-local format
    try {
        const dt = new Date(currentScheduledFor);
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        const year = dt.getFullYear();
        const month = String(dt.getMonth() + 1).padStart(2, '0');
        const day = String(dt.getDate()).padStart(2, '0');
        const hours = String(dt.getHours()).padStart(2, '0');
        const minutes = String(dt.getMinutes()).padStart(2, '0');
        document.getElementById('edit-datetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
    } catch (e) {
        // Fallback: set to 1 hour from now
        const now = new Date();
        now.setHours(now.getHours() + 1);
        now.setMinutes(0);
        document.getElementById('edit-datetime').value = now.toISOString().slice(0, 16);
    }
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

function submitEdit() {
    const postId = document.getElementById('edit-post-id').value;
    const datetime = document.getElementById('edit-datetime').value;
    
    if (!datetime) {
        alert('Please select a date and time');
        return;
    }
    
    const formData = new FormData();
    formData.append('scheduled_for', datetime);
    
    fetch(`/schedule/${postId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            alert('Post rescheduled for ' + data.scheduled_for_display);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to update'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// Time Slot Management
document.getElementById('addSlotForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('day_of_week', document.getElementById('newSlotDay').value);
    formData.append('time_slot', document.getElementById('newSlotTime').value);
    
    fetch('{{ url_for("schedule_slot_add") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to add time slot');
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
});

function toggleSlot(slotId) {
    fetch(`/schedule/slots/${slotId}/toggle`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to toggle slot');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function deleteSlot(slotId) {
    if (!confirm('Delete this time slot?')) return;
    
    fetch(`/schedule/slots/${slotId}/delete`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload to update next available slots
                location.reload();
            } else {
                alert(data.error || 'Failed to delete slot');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function openEditSlotModal(slotId, dayOfWeek, timeSlot) {
    document.getElementById('edit-slot-id').value = slotId;
    document.getElementById('edit-slot-day').value = dayOfWeek;
    document.getElementById('edit-slot-time').value = timeSlot;
    
    const modal = new bootstrap.Modal(document.getElementById('editSlotModal'));
    modal.show();
}

function submitSlotEdit() {
    const slotId = document.getElementById('edit-slot-id').value;
    const dayOfWeek = document.getElementById('edit-slot-day').value;
    const timeSlot = document.getElementById('edit-slot-time').value;
    
    if (!timeSlot) {
        alert('Please enter a time');
        return;
    }
    
    const formData = new FormData();
    formData.append('day_of_week', dayOfWeek);
    formData.append('time_slot', timeSlot);
    
    fetch(`/schedule/slots/${slotId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to update time slot');
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function updateDailyLimit(platform) {
    const input = document.getElementById(`${platform}-limit-input`);
    const limit = parseInt(input.value) || 0;
    const btn = input.nextElementSibling;
    
    const formData = new FormData();
    formData.append('platform', platform);
    formData.append('limit', limit);
    
    // Show saving state
    const originalText = btn.textContent;
    btn.textContent = '‚è≥';
    btn.disabled = true;
    
    fetch('/schedule/daily-limits', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload to show updated next available slots
            location.reload();
        } else {
            alert(data.error || 'Failed to update limit');
            btn.textContent = originalText;
            btn.disabled = false;
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
    });
}
</script>
{% endblock %}
