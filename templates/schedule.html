{% extends "base.html" %}
{% block title %}Scheduled Posts | PodInsights{% endblock %}
{% block header %}Scheduled Posts{% endblock %}
{% block content %}
<style>
/* Drag-and-drop styling */
.sortable-ghost {
    opacity: 0.4;
    background-color: #e3f2fd !important;
}
.sortable-chosen {
    background-color: #bbdefb !important;
}
.sortable-drag {
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.drag-handle:hover {
    color: #0d6efd !important;
}
tr.not-draggable .drag-handle {
    cursor: not-allowed !important;
}
/* Sortable column header */
th[onclick] {
    user-select: none;
}
th[onclick]:hover {
    background-color: #f8f9fa;
}
.sort-indicator {
    font-size: 0.75em;
    margin-left: 4px;
    opacity: 0.7;
}
</style>
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Scheduled Posts</li>
    </ol>
</nav>

<!-- Social Connections -->
<div class="row mb-4">
    <!-- LinkedIn Connection Status -->
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #0077B5 0%, #005885 100%); color: white;">
                <strong>ğŸ’¼ LinkedIn</strong>
                <span id="linkedin-status-badge" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body">
                <div id="linkedin-status-content">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span>Checking connection...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Threads Connection Status -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #000000 0%, #333333 100%); color: white;">
                <strong>ğŸ§µ Threads</strong>
                <span id="threads-status-badge" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body">
                <div id="threads-status-content">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-dark me-2" role="status"></div>
                        <span>Checking connection...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Slots Configuration -->
<div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#timeSlotsCollapse" style="cursor: pointer;">
        <strong>ğŸ• Posting Schedule (Time Slots)</strong>
        <span class="badge bg-info">{{ time_slots|length }} slot{% if time_slots|length != 1 %}s{% endif %}</span>
    </div>
    <div class="collapse show" id="timeSlotsCollapse">
        <div class="card-body">
            <div class="alert alert-info mb-3" id="next-slots-container">
                <div class="d-flex justify-content-between align-items-start">
                    <strong>ğŸ“Œ Next available slots by platform:</strong>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshNextSlots()" title="Refresh">
                        ğŸ”„
                    </button>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <span class="badge" style="background-color: #0077B5;">ğŸ’¼ LinkedIn</span>
                        <span id="next-slot-linkedin">
                            {% if next_slots and next_slots.linkedin %}
                            {{ next_slots.linkedin }}
                            {% else %}
                            <span class="text-muted">No slots available</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <span class="badge bg-dark">ğŸ§µ Threads</span>
                        <span id="next-slot-threads">
                            {% if next_slots and next_slots.threads %}
                            {{ next_slots.threads }}
                            {% else %}
                            <span class="text-muted">No slots available</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <p class="text-muted mb-3">
                Configure your posting times. When you "Add to Queue" from an article, posts will be automatically scheduled for the next available time slot.
            </p>
            
            <!-- Add New Slot Form -->
            <form id="addSlotForm" class="row g-2 mb-3">
                <div class="col-md-4">
                    <select name="day_of_week" class="form-select form-select-sm" id="newSlotDay">
                        <option value="-1">Every day</option>
                        <option value="0">Monday</option>
                        <option value="1">Tuesday</option>
                        <option value="2">Wednesday</option>
                        <option value="3">Thursday</option>
                        <option value="4">Friday</option>
                        <option value="5">Saturday</option>
                        <option value="6">Sunday</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="time" name="time_slot" class="form-control form-control-sm" id="newSlotTime" required>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-sm btn-primary w-100">
                        <i class="bi bi-plus"></i> Add Time Slot
                    </button>
                </div>
            </form>
            
            <!-- Existing Slots -->
            <div id="timeSlotsContainer">
                {% if time_slots %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for slot in time_slots %}
                            <tr id="slot-row-{{ slot.id }}">
                                <td>{{ slot.day_display }}</td>
                                <td>{{ slot.time_slot }}</td>
                                <td>
                                    {% if slot.enabled %}
                                    <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Disabled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-xs btn-outline-primary" onclick="openEditSlotModal({{ slot.id }}, {{ slot.day_of_week }}, '{{ slot.time_slot }}')" title="Edit">
                                        âœï¸
                                    </button>
                                    <button class="btn btn-xs btn-outline-secondary" onclick="toggleSlot({{ slot.id }})" title="Toggle">
                                        {% if slot.enabled %}â¸ï¸{% else %}â–¶ï¸{% endif %}
                                    </button>
                                    <button class="btn btn-xs btn-outline-danger" onclick="deleteSlot({{ slot.id }})" title="Delete">
                                        ğŸ—‘ï¸
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3 text-muted">
                    <small>No time slots configured. Add your first posting time above.</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Daily Posting Limits -->
<div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#dailyLimitsCollapse" style="cursor: pointer;">
        <strong>ğŸ“Š Daily Posting Limits</strong>
        <span class="badge bg-secondary">Per Platform</span>
    </div>
    <div class="collapse show" id="dailyLimitsCollapse">
        <div class="card-body">
            <p class="text-muted mb-3">
                Set the maximum number of posts that can be scheduled per day for each platform. Set to 0 for unlimited posts.
            </p>
            
            <div class="row g-3">
                <!-- LinkedIn Limit -->
                <div class="col-md-6">
                    <div class="card h-100" style="border-left: 4px solid #0077B5;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold">ğŸ’¼ LinkedIn</span>
                                <span class="badge bg-info" id="linkedin-limit-badge">
                                    {{ daily_limits.get('linkedin', 0) or 'Unlimited' }}{% if daily_limits.get('linkedin', 0) %}/day{% endif %}
                                </span>
                            </div>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="linkedin-limit-input" 
                                       value="{{ daily_limits.get('linkedin', 0) }}" min="0" 
                                       placeholder="0 = unlimited">
                                <button class="btn btn-outline-primary" type="button" onclick="updateDailyLimit('linkedin')">
                                    Save
                                </button>
                            </div>
                            <small class="text-muted">0 = no limit</small>
                        </div>
                    </div>
                </div>
                
                <!-- Threads Limit -->
                <div class="col-md-6">
                    <div class="card h-100" style="border-left: 4px solid #000000;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold">ğŸ§µ Threads</span>
                                <span class="badge bg-dark" id="threads-limit-badge">
                                    {{ daily_limits.get('threads', 0) or 'Unlimited' }}{% if daily_limits.get('threads', 0) %}/day{% endif %}
                                </span>
                            </div>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="threads-limit-input" 
                                       value="{{ daily_limits.get('threads', 0) }}" min="0" 
                                       placeholder="0 = unlimited">
                                <button class="btn btn-outline-dark" type="button" onclick="updateDailyLimit('threads')">
                                    Save
                                </button>
                            </div>
                            <small class="text-muted">0 = no limit</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scheduled Posts Table -->
<div class="card">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <strong>ğŸ“… Scheduled Posts Queue</strong>
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <!-- Filters -->
                <form method="get" class="d-flex align-items-center gap-2 flex-wrap" id="filter-form">
                    <select name="status" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>â³ Pending</option>
                        <option value="posted" {% if status_filter == 'posted' %}selected{% endif %}>âœ… Posted</option>
                        <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>âŒ Failed</option>
                        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>ğŸš« Cancelled</option>
                    </select>
                    <select name="platform" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                        <option value="">All Platforms</option>
                        <option value="linkedin" {% if platform_filter == 'linkedin' %}selected{% endif %}>ğŸ’¼ LinkedIn</option>
                        <option value="threads" {% if platform_filter == 'threads' %}selected{% endif %}>ğŸ§µ Threads</option>
                    </select>
                    <div class="input-group input-group-sm" style="width: auto;">
                        <span class="input-group-text">From</span>
                        <input type="date" name="date_from" class="form-control form-control-sm" 
                               value="{{ date_from }}" onchange="this.form.submit()" style="width: 140px;">
                    </div>
                    <div class="input-group input-group-sm" style="width: auto;">
                        <span class="input-group-text">To</span>
                        <input type="date" name="date_to" class="form-control form-control-sm" 
                               value="{{ date_to }}" onchange="this.form.submit()" style="width: 140px;">
                    </div>
                    <input type="hidden" name="sort" value="{{ sort_order }}">
                    {% if status_filter or platform_filter or date_from or date_to %}
                    <a href="{{ url_for('schedule_list') }}{% if sort_order != 'asc' %}?sort={{ sort_order }}{% endif %}" class="btn btn-sm btn-outline-secondary" title="Clear Filters">âœ•</a>
                    {% endif %}
                </form>
                <span class="badge" style="background-color: #0077B5;">ğŸ’¼ {{ linkedin_count }}</span>
                <span class="badge bg-dark">ğŸ§µ {{ threads_count }}</span>
                <span class="badge bg-secondary">{{ scheduled_posts|length }} total</span>
                <button class="btn btn-sm btn-outline-primary d-none" id="move-top-btn" onclick="moveSelectedToTop()" title="Move selected to top of queue">
                    â¬†ï¸ Move to Top
                </button>
                <button class="btn btn-sm btn-outline-primary d-none" id="move-bottom-btn" onclick="moveSelectedToBottom()" title="Move selected to bottom of queue">
                    â¬‡ï¸ Move to Bottom
                </button>
                <button class="btn btn-sm btn-outline-danger d-none" id="delete-selected-btn" onclick="deleteSelected()">
                    ğŸ—‘ï¸ Delete Selected (<span id="selected-count">0</span>)
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshQueue()" id="refresh-queue-btn" title="Refresh Queue">
                    ğŸ”„ Refresh
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="clearQueue()" title="Clear all pending posts">
                    ğŸ—‘ï¸ Clear Pending
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if scheduled_posts %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 30px;" title="Drag to reorder">â‹®â‹®</th>
                        <th style="width: 40px;">
                            <input type="checkbox" class="form-check-input" id="select-all" onchange="toggleSelectAll(this)">
                        </th>
                        <th>Status</th>
                        <th style="cursor: pointer;" onclick="toggleSort()" title="Click to sort">
                            Scheduled For
                            {% if sort_order == 'asc' %}
                            <span class="sort-indicator">â–²</span>
                            {% else %}
                            <span class="sort-indicator">â–¼</span>
                            {% endif %}
                        </th>
                        <th>Type</th>
                        <th>Content Preview</th>
                        <th>Platform</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="schedule-tbody">
                    {% for post in scheduled_posts %}
                    <tr data-post-id="{{ post.id }}" data-scheduled-for="{{ post.scheduled_for }}" class="{% if post.status != 'pending' %}not-draggable{% endif %}">
                        <td class="drag-handle" style="cursor: {% if post.status == 'pending' %}grab{% else %}not-allowed{% endif %}; text-align: center; color: {% if post.status == 'pending' %}#6c757d{% else %}#dee2e6{% endif %};">
                            {% if post.status == 'pending' %}â‹®â‹®{% else %}&nbsp;{% endif %}
                        </td>
                        <td>
                            <input type="checkbox" class="form-check-input post-checkbox" 
                                   data-post-id="{{ post.id }}" onchange="updateSelectedCount()">
                        </td>
                        <td>
                            {% if post.status == 'pending' %}
                            <span class="badge bg-warning text-dark">â³ Pending</span>
                            {% elif post.status == 'posted' %}
                            <span class="badge bg-success">âœ… Posted</span>
                            {% elif post.status == 'failed' %}
                            <span class="badge bg-danger" title="{{ post.error_message or '' }}">âŒ Failed</span>
                            {% elif post.status == 'cancelled' %}
                            <span class="badge bg-secondary">ğŸš« Cancelled</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ post.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span title="{{ post.scheduled_for }}">
                                {{ post.scheduled_for_display or post.scheduled_for }}
                            </span>
                            {% if post.posted_at %}
                            <br><small class="text-muted">Posted: {{ post.posted_at }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if post.post_type == 'social' %}
                            <span class="badge bg-info">Social Post</span>
                            {% elif post.post_type == 'article' %}
                            <span class="badge bg-primary">Article</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ post.post_type }}</span>
                            {% endif %}
                        </td>
                        <td class="description-cell" style="max-width: 300px;">
                            {% if post.social_content %}
                            {{ post.social_content[:100] }}{% if post.social_content|length > 100 %}...{% endif %}
                            {% elif post.standalone_content %}
                            {{ post.standalone_content[:100] }}{% if post.standalone_content|length > 100 %}...{% endif %}
                            {% elif post.article_topic %}
                            <strong>{{ post.article_topic }}</strong>
                            {% else %}
                            <span class="text-muted">No content preview</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if post.platform == 'linkedin' %}
                            <span class="badge" style="background-color: #0077B5;">ğŸ’¼ LinkedIn</span>
                            {% elif post.platform == 'threads' %}
                            <span class="badge" style="background-color: #000000;">ğŸ§µ Threads</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ post.platform }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if post.status == 'pending' %}
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal({{ post.id }}, '{{ post.scheduled_for }}')" title="Edit Time">
                                âœï¸ Time
                            </button>
                            {% if post.social_post_id or post.standalone_post_id %}
                            <button class="btn btn-sm btn-outline-secondary" onclick="openEditContentModal({{ post.social_post_id or post.standalone_post_id }}, '{{ 'social' if post.social_post_id else 'standalone' }}', '{{ post.platform }}')" title="Edit Content" data-content="{{ (post.social_content or post.standalone_content or '')|e }}" data-image-url="{{ (post.social_image_url or post.standalone_image_url or '')|e }}">
                                ğŸ“ Content
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-success" onclick="postNow({{ post.id }}, '{{ post.platform }}')" title="Post Now">
                                ğŸš€ Post Now
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="cancelPost({{ post.id }})" title="Cancel">
                                ğŸš« Cancel
                            </button>
                            {% elif post.status == 'posted' and post.linkedin_post_urn %}
                                {% if post.platform == 'threads' %}
                                    {% if post.linkedin_post_urn.startswith('http') %}
                                    <a href="{{ post.linkedin_post_urn }}" 
                                       target="_blank" class="btn btn-sm btn-outline-dark" title="View on Threads">
                                        ğŸ”— View
                                    </a>
                                    {% else %}
                                    <span class="text-muted small">No view link</span>
                                    {% endif %}
                                {% else %}
                                <a href="https://www.linkedin.com/feed/update/{{ post.linkedin_post_urn }}" 
                                   target="_blank" class="btn btn-sm btn-outline-primary" title="View on LinkedIn">
                                    ğŸ”— View
                                </a>
                                {% endif %}
                            {% elif post.status == 'failed' %}
                            <button class="btn btn-sm btn-outline-success" onclick="retryPost({{ post.id }})" title="Retry Posting">
                                ğŸ”„ Retry
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePost({{ post.id }})" title="Delete">
                                ğŸ—‘ï¸ Delete
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showError('{{ post.error_message|e }}')" title="Show Error">
                                â„¹ï¸ Error
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePost({{ post.id }})" title="Delete">
                                ğŸ—‘ï¸ Delete
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <div style="font-size: 3rem;">ğŸ“…</div>
            <h5 class="mt-3">No scheduled posts</h5>
            <p>Schedule posts from the article page to see them here.</p>
            <a href="{{ url_for('view_articles') }}" class="btn btn-primary">View Articles</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Error Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="errorContent" class="mb-0" style="white-space: pre-wrap;"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #0077B5 0%, #005885 100%); color: white;">
                <h5 class="modal-title">âœï¸ Edit Scheduled Time</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-post-id">
                <div class="mb-3">
                    <label class="form-label">New Scheduled Time</label>
                    <input type="datetime-local" class="form-control" id="edit-datetime" required>
                </div>
                <div class="alert alert-info mb-0">
                    <small>
                        <strong>ğŸ’¡ Tip:</strong> You can also use the time slots. The next available slot is shown on the Schedule page.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEdit()">
                    ğŸ’¾ Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Time Slot Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">âœï¸ Edit Time Slot</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-slot-id">
                <div class="mb-3">
                    <label class="form-label">Day of Week</label>
                    <select class="form-select" id="edit-slot-day">
                        <option value="-1">Every day</option>
                        <option value="0">Monday</option>
                        <option value="1">Tuesday</option>
                        <option value="2">Wednesday</option>
                        <option value="3">Thursday</option>
                        <option value="4">Friday</option>
                        <option value="5">Saturday</option>
                        <option value="6">Sunday</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Time</label>
                    <input type="time" class="form-control" id="edit-slot-time" required>
                </div>
                <div class="alert alert-info mb-0">
                    <small>
                        <strong>ğŸ’¡ Note:</strong> Editing this slot will automatically redistribute all pending posts to use the optimal schedule.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSlotEdit()">
                    ğŸ’¾ Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Content Modal -->
<div class="modal fade" id="editContentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">ğŸ“ Edit Post Content</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-content-post-id">
                <input type="hidden" id="edit-content-post-type">
                <input type="hidden" id="edit-content-image-url">
                <input type="hidden" id="edit-content-original-image-url">
                
                <!-- Post Content Section -->
                <div class="mb-3">
                    <label class="form-label">Post Content</label>
                    <textarea class="form-control" id="edit-content-textarea" rows="6" oninput="updateCharCount()"></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted">Character count: <span id="edit-char-count">0</span></small>
                    <small class="text-muted" id="edit-content-platform"></small>
                </div>
                
                <!-- Image Section -->
                <div class="mb-3">
                    <label class="form-label">Image (optional)</label>
                    
                    <!-- Current Image Preview -->
                    <div id="edit-content-image-preview" class="mb-2 text-center"></div>
                    
                    <!-- Image Source Tabs -->
                    <ul class="nav nav-pills nav-fill mb-2" style="font-size: 0.85rem;">
                        <li class="nav-item">
                            <button class="nav-link active py-1" type="button" onclick="switchContentImageTab('upload')" id="content-upload-tab">
                                ğŸ“ Upload
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link py-1" type="button" onclick="switchContentImageTab('url')" id="content-url-tab">
                                ğŸ”— URL
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link py-1" type="button" onclick="switchContentImageTab('library')" id="content-library-tab">
                                ğŸ“š Library
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Upload Pane -->
                    <div id="content-upload-pane">
                        <input type="file" class="form-control" id="edit-content-image-file" 
                               accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
                               onchange="handleContentImageFile(this)">
                        <div id="content-upload-progress" class="mt-1 d-none">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%;">
                                    Uploading...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- URL Pane -->
                    <div id="content-url-pane" class="d-none">
                        <div class="input-group">
                            <input type="url" class="form-control" id="edit-content-image-url-input" 
                                   placeholder="https://example.com/image.jpg">
                            <button class="btn btn-outline-secondary" type="button" onclick="previewContentImageUrl()" title="Preview">
                                ğŸ‘ï¸
                            </button>
                            <button class="btn btn-success" type="button" onclick="applyContentImageUrl()">
                                Apply
                            </button>
                        </div>
                    </div>
                    
                    <!-- Library Pane -->
                    <div id="content-library-pane" class="d-none">
                        <div id="content-library-grid" class="d-flex flex-wrap gap-1" style="max-height: 150px; overflow-y: auto;">
                            <div class="text-muted small">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- Remove Image Button -->
                    <button type="button" class="btn btn-sm btn-outline-danger mt-2 d-none" id="remove-content-image-btn" 
                            onclick="clearContentImage()">
                        ğŸ—‘ï¸ Remove Image
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitContentEdit()">
                    ğŸ’¾ Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Lightbox Modal -->
<div class="modal fade" id="imageLightboxModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background: transparent; border: none;">
            <div class="modal-body p-0 text-center">
                <img id="lightbox-image" src="" alt="Image preview" class="img-fluid" style="max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2" data-bs-dismiss="modal" aria-label="Close" style="background-color: rgba(0,0,0,0.5); padding: 10px; border-radius: 50%;"></button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Image lightbox function
function openImageLightbox(imageUrl) {
    const lightboxImage = document.getElementById('lightbox-image');
    lightboxImage.src = imageUrl;
    new bootstrap.Modal(document.getElementById('imageLightboxModal')).show();
}

// Check connection status on load
document.addEventListener('DOMContentLoaded', function() {
    checkLinkedInStatus();
    checkThreadsStatus();
    // Auto-refresh next slots to ensure they're current
    refreshNextSlots();
    
    // Initialize drag-and-drop sorting for the schedule queue
    initSortable();
});

// Initialize SortableJS for queue reordering
function initSortable() {
    const tbody = document.getElementById('schedule-tbody');
    if (!tbody) return;
    
    new Sortable(tbody, {
        animation: 150,
        handle: '.drag-handle',
        filter: '.not-draggable',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onMove: function(evt) {
            // Prevent dragging onto non-draggable rows
            return !evt.related.classList.contains('not-draggable');
        },
        onEnd: function(evt) {
            // Only process if position actually changed
            if (evt.oldIndex === evt.newIndex) return;
            
            // Get all pending post IDs in new order
            const rows = tbody.querySelectorAll('tr:not(.not-draggable)');
            const pendingPostIds = Array.from(rows).map(row => parseInt(row.dataset.postId));
            
            if (pendingPostIds.length > 1) {
                reorderQueue(pendingPostIds);
            }
        }
    });
}

// Reorder queue by sending new order to backend
function reorderQueue(postIds) {
    // Show loading indicator
    const tbody = document.getElementById('schedule-tbody');
    tbody.style.opacity = '0.5';
    
    fetch('/schedule/reorder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ post_ids: postIds }),
    })
    .then(response => response.json())
    .then(data => {
        tbody.style.opacity = '1';
        if (data.success) {
            // Reload to show updated times
            location.reload();
        } else {
            alert('Failed to reorder: ' + (data.error || 'Unknown error'));
            location.reload(); // Reload to restore original order
        }
    })
    .catch(error => {
        tbody.style.opacity = '1';
        alert('Error reordering queue: ' + error.message);
        location.reload();
    });
}

// Refresh next available slots display
function refreshNextSlots() {
    const linkedinSpan = document.getElementById('next-slot-linkedin');
    const threadsSpan = document.getElementById('next-slot-threads');
    
    // Show loading state
    if (linkedinSpan) linkedinSpan.innerHTML = '<span class="text-muted">Loading...</span>';
    if (threadsSpan) threadsSpan.innerHTML = '<span class="text-muted">Loading...</span>';
    
    // Fetch LinkedIn next slot
    fetch('/schedule/next-slot?platform=linkedin')
        .then(response => response.json())
        .then(data => {
            if (linkedinSpan) {
                if (data.available && data.display) {
                    linkedinSpan.textContent = data.display;
                } else {
                    linkedinSpan.innerHTML = '<span class="text-muted">No slots available</span>';
                }
            }
        })
        .catch(() => {
            if (linkedinSpan) linkedinSpan.innerHTML = '<span class="text-muted">Error loading</span>';
        });
    
    // Fetch Threads next slot
    fetch('/schedule/next-slot?platform=threads')
        .then(response => response.json())
        .then(data => {
            if (threadsSpan) {
                if (data.available && data.display) {
                    threadsSpan.textContent = data.display;
                } else {
                    threadsSpan.innerHTML = '<span class="text-muted">No slots available</span>';
                }
            }
        })
        .catch(() => {
            if (threadsSpan) threadsSpan.innerHTML = '<span class="text-muted">Error loading</span>';
        });
}

// Toggle sort order for scheduled_for column
function toggleSort() {
    const currentSort = document.querySelector('input[name="sort"]')?.value || 'asc';
    const newSort = currentSort === 'asc' ? 'desc' : 'asc';
    
    // Update the hidden input
    const sortInput = document.querySelector('input[name="sort"]');
    if (sortInput) {
        sortInput.value = newSort;
    }
    
    // Submit the form to apply the new sort
    document.getElementById('filter-form').submit();
}

// Refresh the scheduled posts queue without full page reload
function refreshQueue() {
    const btn = document.getElementById('refresh-queue-btn');
    const tbody = document.getElementById('schedule-tbody');
    const linkedinBadge = document.querySelector('.badge[style*="0077B5"]');
    const threadsBadge = document.querySelector('.badge.bg-dark');
    const totalBadge = document.querySelector('.badge.bg-secondary');
    
    // Show loading state
    const originalBtnText = btn.innerHTML;
    btn.innerHTML = 'â³ Loading...';
    btn.disabled = true;
    if (tbody) tbody.style.opacity = '0.5';
    
    // Get current filter values
    const statusFilter = document.querySelector('select[name="status"]')?.value || '';
    const platformFilter = document.querySelector('select[name="platform"]')?.value || '';
    const dateFrom = document.querySelector('input[name="date_from"]')?.value || '';
    const dateTo = document.querySelector('input[name="date_to"]')?.value || '';
    const sortOrder = document.querySelector('input[name="sort"]')?.value || 'asc';
    
    const params = new URLSearchParams();
    if (statusFilter) params.append('status', statusFilter);
    if (platformFilter) params.append('platform', platformFilter);
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    if (sortOrder) params.append('sort', sortOrder);
    
    fetch(`/schedule/list-json?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = originalBtnText;
            btn.disabled = false;
            if (tbody) tbody.style.opacity = '1';
            
            if (data.success) {
                // Update badges
                if (linkedinBadge) linkedinBadge.innerHTML = `ğŸ’¼ ${data.linkedin_count}`;
                if (threadsBadge) threadsBadge.innerHTML = `ğŸ§µ ${data.threads_count}`;
                if (totalBadge) totalBadge.textContent = `${data.total_count} total`;
                
                // Rebuild table body
                if (tbody && data.posts) {
                    rebuildQueueTable(data.posts);
                }
                
                // Also refresh next slots
                refreshNextSlots();
            } else {
                alert('Failed to refresh: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            btn.innerHTML = originalBtnText;
            btn.disabled = false;
            if (tbody) tbody.style.opacity = '1';
            alert('Error refreshing queue: ' + error.message);
        });
}

// Rebuild the queue table with new data
function rebuildQueueTable(posts) {
    const tbody = document.getElementById('schedule-tbody');
    if (!tbody) return;
    
    if (posts.length === 0) {
        // Show empty state - redirect to reload for proper template rendering
        location.reload();
        return;
    }
    
    tbody.innerHTML = posts.map(post => {
        const statusBadge = getStatusBadge(post.status, post.error_message);
        const platformBadge = getPlatformBadge(post.platform);
        const typeBadge = getTypeBadge(post.post_type);
        const contentPreview = post.content_preview || post.article_topic || '<span class="text-muted">No content preview</span>';
        const isDraggable = post.status === 'pending';
        const rowClass = isDraggable ? '' : 'not-draggable';
        
        return `
            <tr data-post-id="${post.id}" data-scheduled-for="${post.scheduled_for}" class="${rowClass}">
                <td class="drag-handle" style="cursor: ${isDraggable ? 'grab' : 'not-allowed'}; text-align: center; color: ${isDraggable ? '#6c757d' : '#dee2e6'};">
                    ${isDraggable ? 'â‹®â‹®' : '&nbsp;'}
                </td>
                <td>
                    <input type="checkbox" class="form-check-input post-checkbox" 
                           data-post-id="${post.id}" onchange="updateSelectedCount()">
                </td>
                <td>${statusBadge}</td>
                <td>
                    <span title="${post.scheduled_for}">
                        ${post.scheduled_for_display || post.scheduled_for}
                    </span>
                    ${post.posted_at ? `<br><small class="text-muted">Posted: ${post.posted_at}</small>` : ''}
                </td>
                <td>${typeBadge}</td>
                <td class="description-cell" style="max-width: 300px;">${contentPreview}</td>
                <td>${platformBadge}</td>
                <td>${getActionButtons(post)}</td>
            </tr>
        `;
    }).join('');
    
    // Reinitialize sortable after rebuild
    initSortable();
}

function getStatusBadge(status, errorMessage) {
    switch(status) {
        case 'pending': return '<span class="badge bg-warning text-dark">â³ Pending</span>';
        case 'posted': return '<span class="badge bg-success">âœ… Posted</span>';
        case 'failed': return `<span class="badge bg-danger" title="${errorMessage || ''}">âŒ Failed</span>`;
        case 'cancelled': return '<span class="badge bg-secondary">ğŸš« Cancelled</span>';
        default: return `<span class="badge bg-secondary">${status}</span>`;
    }
}

function getPlatformBadge(platform) {
    switch(platform) {
        case 'linkedin': return '<span class="badge" style="background-color: #0077B5;">ğŸ’¼ LinkedIn</span>';
        case 'threads': return '<span class="badge" style="background-color: #000000;">ğŸ§µ Threads</span>';
        default: return `<span class="badge bg-secondary">${platform}</span>`;
    }
}

function getTypeBadge(postType) {
    switch(postType) {
        case 'social': return '<span class="badge bg-info">Social Post</span>';
        case 'article': return '<span class="badge bg-primary">Article</span>';
        default: return `<span class="badge bg-secondary">${postType}</span>`;
    }
}

function getActionButtons(post) {
    if (post.status === 'pending') {
        return `
            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${post.id}, '${post.scheduled_for}')" title="Edit Time">
                âœï¸ Time
            </button>
            <button class="btn btn-sm btn-success" onclick="postNow(${post.id}, '${post.platform}')" title="Post Now">
                ğŸš€ Post Now
            </button>
            <button class="btn btn-sm btn-outline-warning" onclick="cancelPost(${post.id})" title="Cancel">
                ğŸš« Cancel
            </button>
        `;
    } else if (post.status === 'posted' && post.linkedin_post_urn) {
        if (post.platform === 'threads' && post.linkedin_post_urn.startsWith('http')) {
            return `<a href="${post.linkedin_post_urn}" target="_blank" class="btn btn-sm btn-outline-dark" title="View on Threads">ğŸ”— View</a>`;
        } else if (post.platform === 'linkedin') {
            return `<a href="https://www.linkedin.com/feed/update/${post.linkedin_post_urn}" target="_blank" class="btn btn-sm btn-outline-primary" title="View on LinkedIn">ğŸ”— View</a>`;
        }
        return '';
    } else if (post.status === 'failed') {
        return `
            <button class="btn btn-sm btn-outline-success" onclick="retryPost(${post.id})" title="Retry Posting">
                ğŸ”„ Retry
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})" title="Delete">
                ğŸ—‘ï¸ Delete
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="showError('${(post.error_message || '').replace(/'/g, "\\'")}')" title="Show Error">
                â„¹ï¸ Error
            </button>
        `;
    } else {
        return `
            <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})" title="Delete">
                ğŸ—‘ï¸ Delete
            </button>
        `;
    }
}

function checkLinkedInStatus() {
    fetch('{{ url_for("linkedin_status") }}')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('linkedin-status-badge');
            const content = document.getElementById('linkedin-status-content');
            
            if (data.connected && data.needs_configuration) {
                // Connected but needs member ID configuration
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Needs Setup';
                content.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>âš ï¸ Configuration Required</strong><br>
                                <small>Your LinkedIn account is connected, but you need to configure your Member ID to post.</small>
                            </div>
                            <div class="ms-3">
                                <a href="${data.configure_url || '{{ url_for("linkedin_configure") }}'}" class="btn btn-warning btn-sm">
                                    Configure Now
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.connected) {
                badge.className = 'badge bg-success';
                badge.textContent = 'Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${data.display_name || 'LinkedIn User'}</strong>
                            ${data.email ? '<br><small class="text-muted">' + data.email + '</small>' : ''}
                            ${data.user_urn ? '<br><small class="text-muted font-monospace">' + data.user_urn + '</small>' : ''}
                        </div>
                        <div>
                            <a href="{{ url_for('linkedin_configure') }}" class="btn btn-sm btn-outline-secondary me-2">
                                Configure
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="disconnectLinkedIn()">
                                Disconnect
                            </button>
                        </div>
                    </div>
                `;
            } else if (data.configured) {
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Not Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${data.message || 'Click to connect your LinkedIn account'}</span>
                        <a href="{{ url_for('linkedin_auth') }}" class="btn btn-primary">
                            Connect LinkedIn
                        </a>
                    </div>
                `;
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Not Configured';
                content.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <strong>LinkedIn Not Configured</strong><br>
                        <small>${data.message || 'Set LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET environment variables.'}</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error checking LinkedIn status:', error);
            document.getElementById('linkedin-status-badge').textContent = 'Error';
            document.getElementById('linkedin-status-content').innerHTML = 
                '<span class="text-danger">Failed to check LinkedIn status</span>';
        });
}

function disconnectLinkedIn() {
    if (!confirm('Are you sure you want to disconnect LinkedIn?')) return;
    
    fetch('{{ url_for("linkedin_disconnect") }}', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkLinkedInStatus();
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

// Check Threads connection status
function checkThreadsStatus() {
    fetch('{{ url_for("threads_status") }}')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('threads-status-badge');
            const content = document.getElementById('threads-status-content');
            
            if (data.connected) {
                badge.className = 'badge bg-success';
                badge.textContent = 'Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            ${data.profile_picture_url ? '<img src="' + data.profile_picture_url + '" class="rounded-circle me-2" width="40" height="40" alt="">' : ''}
                            <div>
                                <strong>@${data.username || 'Threads User'}</strong>
                                ${data.display_name && data.display_name !== data.username ? '<br><small class="text-muted">' + data.display_name + '</small>' : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="disconnectThreads()">
                            Disconnect
                        </button>
                    </div>
                `;
            } else if (data.configured) {
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Not Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${data.message || 'Click to connect your Threads account'}</span>
                        <a href="{{ url_for('threads_auth') }}" class="btn btn-dark">
                            Connect Threads
                        </a>
                    </div>
                `;
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Not Configured';
                content.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <strong>Threads Not Configured</strong><br>
                        <small>${data.message || 'Set THREADS_APP_ID and THREADS_APP_SECRET environment variables.'}</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error checking Threads status:', error);
            document.getElementById('threads-status-badge').textContent = 'Error';
            document.getElementById('threads-status-content').innerHTML = 
                '<span class="text-danger">Failed to check Threads status</span>';
        });
}

function disconnectThreads() {
    if (!confirm('Are you sure you want to disconnect Threads?')) return;
    
    fetch('{{ url_for("threads_disconnect") }}', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkThreadsStatus();
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function postNow(postId, platform) {
    if (!confirm(`Post this ${platform} content immediately?`)) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'â³ Posting...';
    
    fetch(`/schedule/${postId}/post-now`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.innerHTML = 'âœ… Posted!';
                btn.className = 'btn btn-sm btn-success';
                setTimeout(() => location.reload(), 1500);
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert(data.error || 'Failed to post');
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('Error: ' + error.message);
        });
}

function cancelPost(postId) {
    if (!confirm('Cancel this scheduled post?')) return;
    
    fetch(`/schedule/${postId}/cancel`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to cancel post');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function deletePost(postId) {
    if (!confirm('Delete this scheduled post?')) return;
    
    fetch(`/schedule/${postId}/delete`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to delete post');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function retryPost(postId) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ Retrying...';
    btn.disabled = true;
    
    fetch(`/schedule/${postId}/retry`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Post successful!');
                location.reload();
            } else {
                alert(data.error || 'Retry failed');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function clearQueue() {
    if (!confirm('Clear ALL pending posts from the queue? This cannot be undone.')) return;
    
    fetch('/schedule/clear-queue', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.error || 'Failed to clear queue');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.post-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.post-checkbox:checked');
    const count = checkboxes.length;
    const countSpan = document.getElementById('selected-count');
    const deleteBtn = document.getElementById('delete-selected-btn');
    const moveTopBtn = document.getElementById('move-top-btn');
    const moveBottomBtn = document.getElementById('move-bottom-btn');
    const selectAll = document.getElementById('select-all');
    
    countSpan.textContent = count;
    
    // Check if any selected posts are pending (only pending posts can be moved)
    const pendingSelected = Array.from(checkboxes).filter(cb => {
        const row = cb.closest('tr');
        return row && !row.classList.contains('not-draggable');
    }).length;
    
    if (count > 0) {
        deleteBtn.classList.remove('d-none');
    } else {
        deleteBtn.classList.add('d-none');
    }
    
    // Show move buttons only if there are pending posts selected
    if (pendingSelected > 0) {
        moveTopBtn.classList.remove('d-none');
        moveBottomBtn.classList.remove('d-none');
    } else {
        moveTopBtn.classList.add('d-none');
        moveBottomBtn.classList.add('d-none');
    }
    
    // Update select-all checkbox state
    const allCheckboxes = document.querySelectorAll('.post-checkbox');
    if (allCheckboxes.length > 0) {
        selectAll.checked = count === allCheckboxes.length;
        selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
    }
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.post-checkbox:checked');
    const postIds = Array.from(checkboxes).map(cb => cb.dataset.postId);
    
    if (postIds.length === 0) {
        alert('No posts selected');
        return;
    }
    
    if (!confirm(`Delete ${postIds.length} selected post${postIds.length !== 1 ? 's' : ''}? This cannot be undone.`)) return;
    
    fetch('/schedule/delete-selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_ids: postIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'Failed to delete posts');
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function moveSelectedToTop() {
    moveSelectedPosts('top');
}

function moveSelectedToBottom() {
    moveSelectedPosts('bottom');
}

function moveSelectedPosts(position) {
    // Get only pending posts that are selected
    const checkboxes = document.querySelectorAll('.post-checkbox:checked');
    const postIds = Array.from(checkboxes)
        .filter(cb => {
            const row = cb.closest('tr');
            return row && !row.classList.contains('not-draggable');
        })
        .map(cb => parseInt(cb.dataset.postId));
    
    if (postIds.length === 0) {
        alert('No pending posts selected');
        return;
    }
    
    const positionText = position === 'top' ? 'top' : 'bottom';
    if (!confirm(`Move ${postIds.length} post${postIds.length !== 1 ? 's' : ''} to the ${positionText} of the queue?`)) return;
    
    // Show loading state
    const btn = position === 'top' ? document.getElementById('move-top-btn') : document.getElementById('move-bottom-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ Moving...';
    btn.disabled = true;
    
    fetch('/schedule/move-position', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_ids: postIds, position: position })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to move posts');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function showError(errorMessage) {
    document.getElementById('errorContent').textContent = errorMessage || 'No error details available';
    new bootstrap.Modal(document.getElementById('errorModal')).show();
}

function openEditModal(postId, currentScheduledFor) {
    document.getElementById('edit-post-id').value = postId;
    
    // Convert ISO datetime to local datetime-local format
    try {
        const dt = new Date(currentScheduledFor);
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        const year = dt.getFullYear();
        const month = String(dt.getMonth() + 1).padStart(2, '0');
        const day = String(dt.getDate()).padStart(2, '0');
        const hours = String(dt.getHours()).padStart(2, '0');
        const minutes = String(dt.getMinutes()).padStart(2, '0');
        document.getElementById('edit-datetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
    } catch (e) {
        // Fallback: set to 1 hour from now
        const now = new Date();
        now.setHours(now.getHours() + 1);
        now.setMinutes(0);
        document.getElementById('edit-datetime').value = now.toISOString().slice(0, 16);
    }
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

function submitEdit() {
    const postId = document.getElementById('edit-post-id').value;
    const datetime = document.getElementById('edit-datetime').value;
    
    if (!datetime) {
        alert('Please select a date and time');
        return;
    }
    
    const formData = new FormData();
    formData.append('scheduled_for', datetime);
    
    fetch(`/schedule/${postId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            alert('Post rescheduled for ' + data.scheduled_for_display);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to update'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// Time Slot Management
document.getElementById('addSlotForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('day_of_week', document.getElementById('newSlotDay').value);
    formData.append('time_slot', document.getElementById('newSlotTime').value);
    
    fetch('{{ url_for("schedule_slot_add") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to add time slot');
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
});

function toggleSlot(slotId) {
    fetch(`/schedule/slots/${slotId}/toggle`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to toggle slot');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function deleteSlot(slotId) {
    if (!confirm('Delete this time slot?')) return;
    
    fetch(`/schedule/slots/${slotId}/delete`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload to update next available slots
                location.reload();
            } else {
                alert(data.error || 'Failed to delete slot');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function openEditSlotModal(slotId, dayOfWeek, timeSlot) {
    document.getElementById('edit-slot-id').value = slotId;
    document.getElementById('edit-slot-day').value = dayOfWeek;
    document.getElementById('edit-slot-time').value = timeSlot;
    
    const modal = new bootstrap.Modal(document.getElementById('editSlotModal'));
    modal.show();
}

function submitSlotEdit() {
    const slotId = document.getElementById('edit-slot-id').value;
    const dayOfWeek = document.getElementById('edit-slot-day').value;
    const timeSlot = document.getElementById('edit-slot-time').value;
    
    if (!timeSlot) {
        alert('Please enter a time');
        return;
    }
    
    const formData = new FormData();
    formData.append('day_of_week', dayOfWeek);
    formData.append('time_slot', timeSlot);
    
    fetch(`/schedule/slots/${slotId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to update time slot');
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// Content editing functions
function openEditContentModal(postId, postType, platform) {
    // Get the content and image from the data attributes of the clicked button
    const btn = event.target.closest('button');
    const currentContent = btn.dataset.content || '';
    const currentImageUrl = btn.dataset.imageUrl || '';
    
    document.getElementById('edit-content-post-id').value = postId;
    document.getElementById('edit-content-post-type').value = postType;
    document.getElementById('edit-content-textarea').value = currentContent;
    document.getElementById('edit-content-image-url').value = currentImageUrl;
    document.getElementById('edit-content-original-image-url').value = currentImageUrl;
    
    // Show platform indicator
    const platformLabel = platform === 'linkedin' ? 'ğŸ’¼ LinkedIn' : 'ğŸ§µ Threads';
    document.getElementById('edit-content-platform').textContent = platformLabel;
    
    // Reset image UI
    resetContentImageUI();
    
    // Show current image preview if exists
    if (currentImageUrl) {
        updateContentImagePreview(currentImageUrl);
    }
    
    // Load image library
    loadContentImageLibrary();
    
    updateCharCount();
    new bootstrap.Modal(document.getElementById('editContentModal')).show();
}

function updateCharCount() {
    const textarea = document.getElementById('edit-content-textarea');
    const count = textarea ? textarea.value.length : 0;
    document.getElementById('edit-char-count').textContent = count;
}

// Image handling functions
function resetContentImageUI() {
    // Reset tabs
    document.getElementById('content-upload-tab').classList.add('active');
    document.getElementById('content-url-tab').classList.remove('active');
    document.getElementById('content-library-tab').classList.remove('active');
    
    // Reset panes
    document.getElementById('content-upload-pane').classList.remove('d-none');
    document.getElementById('content-url-pane').classList.add('d-none');
    document.getElementById('content-library-pane').classList.add('d-none');
    
    // Clear file input
    document.getElementById('edit-content-image-file').value = '';
    document.getElementById('edit-content-image-url-input').value = '';
    
    // Hide progress
    document.getElementById('content-upload-progress').classList.add('d-none');
    
    // Clear preview
    document.getElementById('edit-content-image-preview').innerHTML = '';
    document.getElementById('remove-content-image-btn').classList.add('d-none');
}

function switchContentImageTab(tab) {
    // Update tab buttons
    document.getElementById('content-upload-tab').classList.toggle('active', tab === 'upload');
    document.getElementById('content-url-tab').classList.toggle('active', tab === 'url');
    document.getElementById('content-library-tab').classList.toggle('active', tab === 'library');
    
    // Update panes
    document.getElementById('content-upload-pane').classList.toggle('d-none', tab !== 'upload');
    document.getElementById('content-url-pane').classList.toggle('d-none', tab !== 'url');
    document.getElementById('content-library-pane').classList.toggle('d-none', tab !== 'library');
    
    // Load library if switching to it
    if (tab === 'library') {
        loadContentImageLibrary();
    }
}

function handleContentImageFile(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file type
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('Invalid file type. Please upload PNG, JPG, GIF, or WebP.');
        input.value = '';
        return;
    }
    
    // Show progress
    document.getElementById('content-upload-progress').classList.remove('d-none');
    
    const formData = new FormData();
    formData.append('image', file);
    
    fetch('/compose/upload-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('content-upload-progress').classList.add('d-none');
        
        if (data.success) {
            document.getElementById('edit-content-image-url').value = data.image_url;
            updateContentImagePreview(data.image_url);
            
            if (data.warning) {
                console.warn(data.warning);
            }
        } else {
            alert('Upload failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        document.getElementById('content-upload-progress').classList.add('d-none');
        alert('Upload error: ' + error.message);
    });
}

function previewContentImageUrl() {
    const url = document.getElementById('edit-content-image-url-input').value.trim();
    if (url) {
        updateContentImagePreview(url);
    }
}

function applyContentImageUrl() {
    const url = document.getElementById('edit-content-image-url-input').value.trim();
    if (!url) {
        alert('Please enter an image URL');
        return;
    }
    
    document.getElementById('edit-content-image-url').value = url;
    updateContentImagePreview(url);
}

function loadContentImageLibrary() {
    const grid = document.getElementById('content-library-grid');
    grid.innerHTML = '<div class="text-muted small">Loading...</div>';
    
    fetch('/compose/list-images')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.images && data.images.length > 0) {
                grid.innerHTML = data.images.map(img => `
                    <img src="${img.url}" 
                         class="img-thumbnail" 
                         style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; transition: all 0.15s ease;"
                         onmouseover="this.style.borderColor='#0d6efd'; this.style.transform='scale(1.05)';"
                         onmouseout="this.style.borderColor=''; this.style.transform='';"
                         onclick="selectContentLibraryImage('${img.url}')"
                         title="${img.filename}">
                `).join('');
            } else {
                grid.innerHTML = '<div class="text-muted small">No uploaded images yet</div>';
            }
        })
        .catch(error => {
            grid.innerHTML = '<div class="text-danger small">Failed to load images</div>';
        });
}

function selectContentLibraryImage(url) {
    document.getElementById('edit-content-image-url').value = url;
    updateContentImagePreview(url);
}

function updateContentImagePreview(url) {
    const preview = document.getElementById('edit-content-image-preview');
    const removeBtn = document.getElementById('remove-content-image-btn');
    
    if (url) {
        preview.innerHTML = `
            <img src="${url}" 
                 class="img-thumbnail" 
                 style="max-height: 150px; max-width: 100%; cursor: pointer;"
                 onclick="openImageLightbox('${url}')"
                 title="Click to enlarge"
                 onerror="this.parentElement.innerHTML='<span class=\\'text-danger small\\'>Failed to load image</span>';">
        `;
        removeBtn.classList.remove('d-none');
    } else {
        preview.innerHTML = '';
        removeBtn.classList.add('d-none');
    }
}

function clearContentImage() {
    document.getElementById('edit-content-image-url').value = '';
    document.getElementById('edit-content-image-url-input').value = '';
    document.getElementById('edit-content-image-file').value = '';
    updateContentImagePreview('');
}

function submitContentEdit() {
    const postId = document.getElementById('edit-content-post-id').value;
    const postType = document.getElementById('edit-content-post-type').value;
    const content = document.getElementById('edit-content-textarea').value.trim();
    const imageUrl = document.getElementById('edit-content-image-url').value;
    const originalImageUrl = document.getElementById('edit-content-original-image-url').value;
    
    if (!content) {
        alert('Post content cannot be empty');
        return;
    }
    
    // Show saving state
    const saveBtn = document.querySelector('#editContentModal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Use the appropriate endpoints based on post type
    const contentUrl = postType === 'social' 
        ? `/social/${postId}/edit` 
        : `/compose/post/${postId}/edit`;
    
    const imageEndpoint = postType === 'social' 
        ? `/social/${postId}/image` 
        : `/compose/post/${postId}/image`;
    
    const contentFormData = new FormData();
    contentFormData.append('content', content);
    
    // Save content first
    fetch(contentUrl, { method: 'POST', body: contentFormData })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to save content');
            }
            
            // If image changed, save image too
            if (imageUrl !== originalImageUrl) {
                const imageFormData = new FormData();
                imageFormData.append('image_url', imageUrl);
                
                return fetch(imageEndpoint, { method: 'POST', body: imageFormData })
                    .then(response => response.json());
            }
            return { success: true };
        })
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editContentModal')).hide();
                // Reload to show updated content
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to save'));
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
}

function updateDailyLimit(platform) {
    const input = document.getElementById(`${platform}-limit-input`);
    const limit = parseInt(input.value) || 0;
    const btn = input.nextElementSibling;
    
    const formData = new FormData();
    formData.append('platform', platform);
    formData.append('limit', limit);
    
    // Show saving state
    const originalText = btn.textContent;
    btn.textContent = 'â³';
    btn.disabled = true;
    
    fetch('/schedule/daily-limits', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload to show updated next available slots
            location.reload();
        } else {
            alert(data.error || 'Failed to update limit');
            btn.textContent = originalText;
            btn.disabled = false;
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
    });
}
</script>
{% endblock %}
