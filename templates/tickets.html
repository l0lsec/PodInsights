{% extends "base.html" %}
{% block title %}JIRA Tickets{% endblock %}
{% block header %}JIRA Tickets{% endblock %}
{% block content %}
<!-- Filter Bar -->
<div class="filter-bar">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label">Search</label>
            <input type="text" class="form-control" name="q" value="{{ search_query }}" placeholder="Search tickets, episodes...">
        </div>
        <div class="col-md-2">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
                <option value="">All Statuses</option>
                {% for s in all_statuses %}
                <option value="{{ s }}" {% if filter_status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Sort By</label>
            <select name="sort" class="form-select">
                <option value="id" {% if sort_by == 'id' %}selected{% endif %}>Created</option>
                <option value="episode" {% if sort_by == 'episode' %}selected{% endif %}>Episode</option>
                <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status</option>
                <option value="ticket" {% if sort_by == 'ticket' %}selected{% endif %}>Ticket Key</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Order</label>
            <select name="order" class="form-select">
                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Newest First</option>
                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Oldest First</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-secondary w-100">Apply</button>
        </div>
    </form>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <span class="results-count">
        Showing <strong>{{ tickets|length }}</strong> ticket{% if tickets|length != 1 %}s{% endif %}
        {% if filter_status or search_query %}
        (filtered)
        <a href="{{ url_for('view_tickets') }}" class="ms-2 text-decoration-none">Clear filters</a>
        {% endif %}
    </span>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-danger d-none" id="delete-selected-btn" onclick="deleteSelectedTickets()">
            üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)
        </button>
    </div>
</div>

{% if tickets %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" class="form-check-input" id="select-all" onchange="toggleSelectAll(this)">
                </th>
                <th>Episode</th>
                <th>Preview</th>
                <th>Summary</th>
                <th>Action Item</th>
                <th>Ticket</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for t in tickets %}
            {% set is_audio = t.episode_url.lower().endswith(('.mp3', '.m4a', '.wav', '.ogg', '.aac', '.flac')) %}
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input ticket-checkbox" 
                           data-ticket-id="{{ t.id }}" onchange="updateSelectedCount()">
                </td>
                <td>
                    {% if is_audio %}
                    <a href="{{ url_for('process_episode', url=t.episode_url, title=t.episode_title, feed_id=t.feed_id, published=t.published) }}">
                        {{ t.episode_title }}
                    </a>
                    {% else %}
                    <a href="{{ url_for('process_text_article', url=t.episode_url, title=t.episode_title, feed_id=t.feed_id, published=t.published) }}">
                        {{ t.episode_title }}
                    </a>
                    {% endif %}
                </td>
                <td>
                    {% if is_audio %}
                    <audio controls preload="none" src="{{ t.episode_url }}" style="max-width: 150px; height: 32px;">
                        Your browser does not support the audio element.
                    </audio>
                    {% else %}
                    <a href="{{ t.episode_url }}" target="_blank" class="btn btn-sm btn-outline-secondary">View</a>
                    {% endif %}
                </td>
                <td class="description-cell">{{ t.episode_summary|truncate(200) }}</td>
                <td>{{ t.action_item }}</td>
                <td>
                    <a href="{{ t.ticket_url }}" target="_blank" class="badge bg-primary text-decoration-none">
                        {{ t.ticket_key }}
                    </a>
                </td>
                <td>
                    <span class="badge 
                        {% if t.status == 'Done' or t.status == 'Closed' %}bg-success
                        {% elif t.status == 'In Progress' %}bg-warning text-dark
                        {% elif t.status == 'To Do' or t.status == 'Open' %}bg-info
                        {% else %}bg-secondary{% endif %}">
                        {{ t.status or 'Unknown' }}
                    </span>
                    {% if t.transitions %}
                    <form method="post" action="{{ url_for('update_ticket') }}" class="d-inline">
                        <input type="hidden" name="ticket_key" value="{{ t.ticket_key }}">
                        <input type="hidden" name="ref" value="{{ request.url }}">
                        <select name="transition_id" class="form-select form-select-sm d-inline w-auto mt-1">
                            {% for tr in t.transitions %}
                            <option value="{{ tr.id }}">{{ tr.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-secondary mt-1">‚Üí</button>
                    </form>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTicket({{ t.id }})" title="Delete from database">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.ticket-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.ticket-checkbox:checked');
    const count = checkboxes.length;
    const countSpan = document.getElementById('selected-count');
    const deleteBtn = document.getElementById('delete-selected-btn');
    const selectAll = document.getElementById('select-all');
    
    countSpan.textContent = count;
    
    if (count > 0) {
        deleteBtn.classList.remove('d-none');
    } else {
        deleteBtn.classList.add('d-none');
    }
    
    // Update select-all checkbox state
    const allCheckboxes = document.querySelectorAll('.ticket-checkbox');
    if (allCheckboxes.length > 0) {
        selectAll.checked = count === allCheckboxes.length;
        selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
    }
}

function deleteTicket(ticketId) {
    if (!confirm('Delete this ticket from the database? (This does not delete the ticket in JIRA)')) return;
    
    fetch(`/tickets/${ticketId}/delete`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to delete ticket');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function deleteSelectedTickets() {
    const checkboxes = document.querySelectorAll('.ticket-checkbox:checked');
    const ticketIds = Array.from(checkboxes).map(cb => cb.dataset.ticketId);
    
    if (ticketIds.length === 0) {
        alert('No tickets selected');
        return;
    }
    
    if (!confirm(`Delete ${ticketIds.length} selected ticket${ticketIds.length !== 1 ? 's' : ''} from the database? (This does not delete them in JIRA)`)) return;
    
    fetch('/tickets/delete-selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ticket_ids: ticketIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'Failed to delete tickets');
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}
</script>
{% else %}
<div class="text-center py-5">
    <div class="display-1 mb-3">üé´</div>
    <h3>No Tickets Found</h3>
    {% if filter_status or search_query %}
    <p class="text-muted">No tickets match your current filters.</p>
    {% else %}
    <p class="text-muted">No JIRA tickets have been created yet.</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary">Browse Feeds</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}
