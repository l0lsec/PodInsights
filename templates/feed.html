{% extends "base.html" %}
{% block title %}{{ feed.title }} | PodInsights{% endblock %}
{% block header %}{{ feed.title }}{% endblock %}
{% block content %}
<p><a class="btn btn-secondary" href="{{ url_for('index') }}">Back to feeds</a></p>

{% if episodes %}
{% if is_text_feed %}
{# Text/Article Feed Layout #}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Articles</h2>
    {% if pagination %}<span class="text-muted">{{ pagination.total_items }} total</span>{% endif %}
</div>
<div class="row row-cols-1 row-cols-md-2 g-4">
    {% for ep in episodes %}
    <div class="col">
        <div class="card h-100">
            {% if ep.image %}
            <img src="{{ ep.image }}" class="card-img-top" alt="{{ ep.title }}" style="max-height: 200px; object-fit: cover;">
            {% endif %}
            <div class="card-body">
                <h5 class="card-title">{{ ep.title }}</h5>
                {% if ep.author %}<p class="card-text text-muted small mb-1">By {{ ep.author }}</p>{% endif %}
                {% if ep.published %}<p class="card-text text-muted small mb-2">{{ ep.published[:10] }}</p>{% endif %}
                <p class="card-text">{{ ep.short_description }}</p>
                <div class="d-flex gap-2 flex-wrap mb-2">
                    {% if ep.status.summarized %}<span class="badge bg-success">Summarized</span>{% endif %}
                    {% if ep.status.actions %}<span class="badge bg-info">Actions Extracted</span>{% endif %}
                    {% if ep.status.state == 'new' %}<span class="badge bg-secondary">New</span>{% endif %}
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{{ ep.link }}" target="_blank" class="btn btn-sm btn-outline-secondary">Read Original</a>
                    <a href="{{ url_for('process_text_article', url=ep.enclosure, title=ep.title, feed_id=feed.id, published=ep.published) }}"
                       class="btn btn-sm btn-primary" data-processing="true">
                        {% if ep.status.summarized %}View Results{% else %}Summarize{% endif %}
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
{# Audio Podcast Feed Layout #}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Episodes</h2>
    {% if pagination %}<span class="text-muted">{{ pagination.total_items }} total</span>{% endif %}
</div>
<table class="table table-striped">
    <tr>
        <th>Title</th>
        <th>Released</th>
        <th>Description</th>
        <th>Image</th>
        <th>Play</th>
        <th>Transcribed</th>
        <th>Summarized</th>
        <th>Actions</th>
        <th>Status</th>
        <th>Process</th>
        <th>Queue</th>
    </tr>
    {% for ep in episodes %}
    <tr>
        <td>{{ ep.title }}</td>
        <td class="text-nowrap">{% if ep.published %}{{ ep.published[:10] }}{% else %}-{% endif %}</td>
        <td class="description-cell">
            <span class="desc-short">{{ ep.short_description }}</span>
            <span class="desc-full d-none">{{ ep.description | safe }}</span>
            <button class="btn btn-link p-0 desc-toggle">See more</button>
        </td>
        <td>{% if ep.image %}<img src="{{ ep.image }}" alt="image" width="100">{% endif %}</td>
        <td>
            <audio controls preload="none" src="{{ ep.enclosure }}">
                Your browser does not support the audio element.
            </audio>
        </td>
        <td>{% if ep.status.transcribed %}<span class="processed">Yes</span>{% else %}No{% endif %}</td>
        <td>{% if ep.status.summarized %}<span class="processed">Yes</span>{% else %}No{% endif %}</td>
        <td>{% if ep.status.actions %}<span class="processed">Yes</span>{% else %}No{% endif %}</td>
        <td>{{ ep.status.state }}</td>
        <td>
            <a
                href="{{ url_for('process_episode', url=ep.enclosure, title=ep.title, feed_id=feed.id, published=ep.published) }}"
                data-processing="true"
            >Process</a>
        </td>
        <td>
            <a href="{{ url_for('enqueue_episode', url=ep.enclosure, title=ep.title, feed_id=feed.id, published=ep.published) }}">Queue</a>
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% else %}
<div class="alert alert-info">No items found in this feed.</div>
{% endif %}

{# Pagination Controls #}
{% if pagination and pagination.total_pages > 1 %}
<nav aria-label="Feed pagination" class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <small class="text-muted">
            Showing {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ [pagination.page * pagination.per_page, pagination.total_items] | min }} of {{ pagination.total_items }} items
        </small>
        <div class="btn-group btn-group-sm">
            <a href="{{ url_for('view_feed', feed_id=feed.id, page=pagination.page, per_page=10) }}" 
               class="btn btn-outline-secondary {% if pagination.per_page == 10 %}active{% endif %}">10</a>
            <a href="{{ url_for('view_feed', feed_id=feed.id, page=1, per_page=25) }}" 
               class="btn btn-outline-secondary {% if pagination.per_page == 25 %}active{% endif %}">25</a>
            <a href="{{ url_for('view_feed', feed_id=feed.id, page=1, per_page=50) }}" 
               class="btn btn-outline-secondary {% if pagination.per_page == 50 %}active{% endif %}">50</a>
        </div>
    </div>
    <ul class="pagination justify-content-center">
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('view_feed', feed_id=feed.id, page=1, per_page=pagination.per_page) }}">
                &laquo; First
            </a>
        </li>
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('view_feed', feed_id=feed.id, page=pagination.prev_page or 1, per_page=pagination.per_page) }}">
                &lsaquo; Prev
            </a>
        </li>
        
        {% for p in range(1, pagination.total_pages + 1) %}
            {% if p == pagination.page %}
            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
            {% elif p == 1 or p == pagination.total_pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('view_feed', feed_id=feed.id, page=p, per_page=pagination.per_page) }}">{{ p }}</a>
            </li>
            {% elif p == pagination.page - 3 or p == pagination.page + 3 %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}
        
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('view_feed', feed_id=feed.id, page=pagination.next_page or pagination.total_pages, per_page=pagination.per_page) }}">
                Next &rsaquo;
            </a>
        </li>
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('view_feed', feed_id=feed.id, page=pagination.total_pages, per_page=pagination.per_page) }}">
                Last &raquo;
            </a>
        </li>
    </ul>
</nav>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.desc-toggle').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var shortEl = btn.parentElement.querySelector('.desc-short');
            var fullEl = btn.parentElement.querySelector('.desc-full');
            shortEl.classList.toggle('d-none');
            fullEl.classList.toggle('d-none');
            btn.textContent = btn.textContent.trim() === 'See more' ? 'See less' : 'See more';
        });
    });
});
</script>
{% endblock %}
