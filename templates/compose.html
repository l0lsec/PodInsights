{% extends "base.html" %}
{% block title %}Command Center | PodInsights{% endblock %}
{% block header %}Command Center{% endblock %}
{% block content %}
<style>
    /* Command Center specific styles */
    .compose-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    .compose-header h2 {
        margin: 0;
        font-weight: 700;
        background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .compose-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.8;
    }
    
    /* Tab styling */
    .nav-pills-custom .nav-link {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        color: #495057;
        background: #f8f9fa;
        border: 2px solid transparent;
        transition: all 0.2s ease;
    }
    .nav-pills-custom .nav-link:hover {
        background: #e9ecef;
        border-color: #dee2e6;
    }
    .nav-pills-custom .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }
    
    /* Platform checkbox boxes */
    .platform-checkbox-box {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        border-radius: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 3px solid #dee2e6;
        background: #f8f9fa;
        color: #495057;
        user-select: none;
    }
    .platform-checkbox-box:hover {
        border-color: #adb5bd;
        background: #e9ecef;
    }
    .platform-checkbox-box .check-indicator {
        width: 22px;
        height: 22px;
        border-radius: 6px;
        border: 2px solid #adb5bd;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    .platform-checkbox-box.selected {
        border-color: var(--platform-color);
        background: var(--platform-bg);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    .platform-checkbox-box.selected .check-indicator {
        background: white;
        border-color: white;
        color: var(--platform-color);
    }
    .platform-checkbox-box.selected .check-indicator::after {
        content: '‚úì';
        font-weight: bold;
    }
    /* Platform-specific colors */
    .platform-checkbox-box[data-platform="linkedin"] { --platform-color: #0077B5; --platform-bg: #0077B5; }
    .platform-checkbox-box[data-platform="threads"] { --platform-color: #000; --platform-bg: #000; }
    .platform-checkbox-box[data-platform="twitter"] { --platform-color: #1DA1F2; --platform-bg: #1DA1F2; }
    .platform-checkbox-box[data-platform="bluesky"] { --platform-color: #0085ff; --platform-bg: #0085ff; }
    .platform-checkbox-box[data-platform="facebook"] { --platform-color: #1877F2; --platform-bg: #1877F2; }
    .platform-checkbox-box[data-platform="mastodon"] { --platform-color: #6364ff; --platform-bg: #6364ff; }
    
    /* Tone selector */
    .tone-option {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid #e9ecef;
    }
    .tone-option:hover {
        border-color: #667eea;
    }
    .tone-option.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }
    
    /* Library image hover styles */
    .library-image:hover {
        border-color: #0d6efd !important;
        transform: scale(1.05);
        transition: all 0.15s ease;
    }
    
    /* Loading state */
    .generating-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 1rem;
        z-index: 10;
        border-radius: 12px;
    }
    
    /* Social copy card styles - matching article.html */
    .social-copy-card {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .social-copy-header {
        padding: 0.75rem 1rem;
        color: white;
        font-weight: 500;
    }
    .social-copy-body {
        padding: 1rem;
        background: white;
    }
    .social-copy-text {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 1rem;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: inherit;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    /* Platform colors */
    :root {
        --platform-linkedin-color: #0077B5;
        --platform-twitter-color: #1DA1F2;
        --platform-facebook-color: #1877F2;
        --platform-threads-color: #000000;
        --platform-bluesky-color: #0085ff;
        --platform-mastodon-color: #6364ff;
        --platform-instagram-color: #E4405F;
    }
    
    /* Show more/less button styles */
    .extra-post.d-none {
        display: none !important;
    }
</style>

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Command Center</li>
    </ol>
</nav>

<!-- Header -->
<div class="compose-header">
    <h2>üöÄ Post Command Center</h2>
    <p>Generate AI-powered social media posts from prompts, URLs, or text</p>
</div>

<!-- Platform Connections -->
<div class="row mb-4">
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #0077B5 0%, #005885 100%); color: white;">
                <strong>üíº LinkedIn</strong>
                <span id="linkedin-status-badge" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body py-2">
                <div id="linkedin-status-content">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span>Checking connection...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #000 0%, #333 100%); color: white;">
                <strong>üßµ Threads</strong>
                <span id="threads-status-badge" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body py-2">
                <div id="threads-status-content">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-dark me-2" role="status"></div>
                        <span>Checking connection...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generator Card -->
<div class="card mb-4" style="border-radius: 12px; overflow: hidden;">
    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <strong>‚ú® Generate New Posts</strong>
    </div>
    <div class="card-body position-relative" id="generator-body">
        <!-- Source Type Tabs -->
        <ul class="nav nav-pills nav-pills-custom mb-4" id="sourceTypeTabs" role="tablist">
            <li class="nav-item me-2" role="presentation">
                <button class="nav-link {% if not selected_source %}active{% endif %}" id="freeform-tab" data-bs-toggle="pill" data-bs-target="#freeform-content" type="button" role="tab">
                    üí° Freeform Prompt
                </button>
            </li>
            <li class="nav-item me-2" role="presentation">
                <button class="nav-link" id="url-tab" data-bs-toggle="pill" data-bs-target="#url-content" type="button" role="tab">
                    üîó From URL
                </button>
            </li>
            <li class="nav-item me-2" role="presentation">
                <button class="nav-link" id="text-tab" data-bs-toggle="pill" data-bs-target="#text-content" type="button" role="tab">
                    üìù From Text
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if selected_source %}active{% endif %}" id="saved-tab" data-bs-toggle="pill" data-bs-target="#saved-content" type="button" role="tab">
                    üìö From Saved Source
                    {% if saved_sources %}<span class="badge bg-secondary ms-1">{{ saved_sources|length }}</span>{% endif %}
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="sourceTypeContent">
            <!-- Freeform Tab -->
            <div class="tab-pane fade {% if not selected_source %}show active{% endif %}" id="freeform-content" role="tabpanel">
                <div class="mb-3">
                    <label class="form-label fw-bold">Topic or Prompt</label>
                    <textarea class="form-control" id="freeform-input" rows="4" 
                              placeholder="Enter a topic, idea, or prompt to generate posts about...&#10;&#10;Example: The importance of multi-factor authentication in 2026"></textarea>
                </div>
            </div>
            
            <!-- URL Tab -->
            <div class="tab-pane fade" id="url-content" role="tabpanel">
                <div class="mb-3">
                    <label class="form-label fw-bold">URL to Generate Posts From</label>
                    <input type="url" class="form-control" id="url-input" 
                           placeholder="https://example.com/article">
                    <div class="form-text">Paste a URL and we'll extract the content to generate posts about it.</div>
                </div>
            </div>
            
            <!-- Text Tab -->
            <div class="tab-pane fade" id="text-content" role="tabpanel">
                <div class="mb-3">
                    <label class="form-label fw-bold">Topic (Optional)</label>
                    <input type="text" class="form-control mb-3" id="text-topic" 
                           placeholder="Brief title or topic for this content">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Text Content</label>
                    <textarea class="form-control" id="text-input" rows="6" 
                              placeholder="Paste or write the content you want to transform into social media posts..."></textarea>
                </div>
            </div>
            
            <!-- Saved Source Tab -->
            <div class="tab-pane fade {% if selected_source %}show active{% endif %}" id="saved-content" role="tabpanel">
                {% if saved_sources %}
                <div class="mb-3">
                    <label class="form-label fw-bold">Select a Saved Source</label>
                    <select class="form-select" id="saved-source-select" onchange="onSourceSelected()">
                        <option value="">Choose a source...</option>
                        {% for source in saved_sources %}
                        <option value="{{ source.id }}" 
                                data-title="{{ source.title }}"
                                data-description="{{ source.description }}"
                                data-url="{{ source.url }}"
                                {% if selected_source and selected_source.id == source.id %}selected{% endif %}>
                            {{ source.title or source.url[:50] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="source-preview" class="{% if not selected_source %}d-none{% endif %}">
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title" id="preview-title">
                                {% if selected_source %}{{ selected_source.title }}{% endif %}
                            </h6>
                            <p class="card-text small text-muted" id="preview-description">
                                {% if selected_source %}{{ selected_source.description }}{% endif %}
                            </p>
                            <a href="{% if selected_source %}{{ selected_source.url }}{% else %}#{% endif %}" 
                               target="_blank" rel="noopener" 
                               class="card-link small" id="preview-url">
                                {% if selected_source %}{{ selected_source.url }}{% endif %}
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="text-muted small">
                    <a href="{{ url_for('sources_page') }}">Manage all saved sources ‚Üí</a>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <p>No saved sources yet.</p>
                    <p class="small">When you generate posts from URLs, the extracted content is automatically saved here for reuse.</p>
                    <a href="{{ url_for('sources_page') }}" class="btn btn-sm btn-outline-primary">View Sources Page</a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <hr>
        
        <!-- Platform Selection -->
        <div class="row mb-4">
            <div class="col-md-8">
                <label class="form-label fw-bold mb-3">Select Platforms</label>
                <div class="d-flex flex-wrap gap-3" id="platform-checkboxes">
                    <label class="platform-checkbox-box selected" data-platform="linkedin">
                        <span class="check-indicator"></span>
                        <input type="checkbox" class="d-none" value="linkedin" id="platform-linkedin" checked>
                        üíº LinkedIn
                    </label>
                    <label class="platform-checkbox-box selected" data-platform="threads">
                        <span class="check-indicator"></span>
                        <input type="checkbox" class="d-none" value="threads" id="platform-threads" checked>
                        üßµ Threads
                    </label>
                    <label class="platform-checkbox-box selected" data-platform="twitter">
                        <span class="check-indicator"></span>
                        <input type="checkbox" class="d-none" value="twitter" id="platform-twitter" checked>
                        ùïè Twitter
                    </label>
                    <label class="platform-checkbox-box" data-platform="bluesky">
                        <span class="check-indicator"></span>
                        <input type="checkbox" class="d-none" value="bluesky" id="platform-bluesky">
                        ü¶ã Bluesky
                    </label>
                    <label class="platform-checkbox-box" data-platform="facebook">
                        <span class="check-indicator"></span>
                        <input type="checkbox" class="d-none" value="facebook" id="platform-facebook">
                        üìò Facebook
                    </label>
                    <label class="platform-checkbox-box" data-platform="mastodon">
                        <span class="check-indicator"></span>
                        <input type="checkbox" class="d-none" value="mastodon" id="platform-mastodon">
                        üêò Mastodon
                    </label>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold" for="posts-per-platform">Posts per Platform</label>
                <div class="input-group">
                    <button class="btn btn-outline-secondary" type="button" onclick="adjustPostCount(-1)">‚àí</button>
                    <input type="number" class="form-control text-center" id="posts-per-platform" value="1" min="1" max="10">
                    <button class="btn btn-outline-secondary" type="button" onclick="adjustPostCount(1)">+</button>
                </div>
                <small class="text-muted">Generate 1-10 unique posts per platform</small>
            </div>
        </div>
        
        <!-- Bulk Image -->
        <div class="mb-4">
            <label class="form-label fw-bold">
                üñºÔ∏è Image (Optional)
            </label>
            
            <!-- Image Source Tabs -->
            <ul class="nav nav-pills nav-fill mb-3" id="imageSourceTabs" role="tablist" style="font-size: 0.85rem;">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active py-2" id="image-upload-tab" data-bs-toggle="pill" data-bs-target="#image-upload-pane" type="button" role="tab">
                        üìÅ Upload File
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link py-2" id="image-url-tab" data-bs-toggle="pill" data-bs-target="#image-url-pane" type="button" role="tab">
                        üîó From URL
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link py-2" id="image-library-tab" data-bs-toggle="pill" data-bs-target="#image-library-pane" type="button" role="tab" onclick="loadImageLibrary('bulk')">
                        üìö From Library
                    </button>
                </li>
            </ul>
            
            <div class="tab-content">
                <!-- Upload File Tab -->
                <div class="tab-pane fade show active" id="image-upload-pane" role="tabpanel">
                    <div class="input-group">
                        <input type="file" class="form-control" id="bulk-image-file" 
                            accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
                            onchange="handleImageFileSelect(this)">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearBulkImageFile()" title="Clear Image">
                            ‚úï
                        </button>
                    </div>
                    <small class="text-muted">Upload an image from your computer (max 16MB)</small>
                    <div id="upload-progress" class="mt-2 d-none">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                                Uploading...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- URL Tab -->
                <div class="tab-pane fade" id="image-url-pane" role="tabpanel">
                    <div class="input-group">
                        <input type="url" class="form-control" id="bulk-image-url" 
                            placeholder="https://example.com/image.jpg">
                        <button class="btn btn-outline-secondary" type="button" onclick="previewBulkImage()" title="Preview Image">
                            üëÅÔ∏è
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="clearBulkImage()" title="Clear Image">
                            ‚úï
                        </button>
                    </div>
                    <small class="text-muted">Enter a public URL accessible by LinkedIn/Threads</small>
                </div>
                
                <!-- Library Tab -->
                <div class="tab-pane fade" id="image-library-pane" role="tabpanel">
                    <div id="image-library-grid" class="d-flex flex-wrap gap-2" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-muted small">Loading images...</div>
                    </div>
                    <small class="text-muted mt-1 d-block">Click an image to select it</small>
                </div>
            </div>
            
            <!-- Shared Preview Area -->
            <div id="bulk-image-preview" class="mt-2 d-none">
                <img src="" alt="Image preview" class="img-thumbnail" style="max-height: 150px;">
                <span id="bulk-image-filename" class="ms-2 text-muted small"></span>
            </div>
            
            <!-- Hidden field to store the final image URL (from upload or URL input) -->
            <input type="hidden" id="final-image-url" value="">
        </div>
        
        <!-- Tone Selection -->
        <div class="mb-4">
            <label class="form-label fw-bold mb-3">Tone & Style</label>
            <div class="d-flex flex-wrap gap-2">
                <label class="tone-option selected" data-tone="professional">
                    <input type="radio" name="tone" value="professional" class="d-none" checked>
                    üëî Professional
                </label>
                <label class="tone-option" data-tone="casual">
                    <input type="radio" name="tone" value="casual" class="d-none">
                    üòä Casual
                </label>
                <label class="tone-option" data-tone="witty">
                    <input type="radio" name="tone" value="witty" class="d-none">
                    üòÑ Witty
                </label>
                <label class="tone-option" data-tone="educational">
                    <input type="radio" name="tone" value="educational" class="d-none">
                    üìö Educational
                </label>
                <label class="tone-option" data-tone="promotional">
                    <input type="radio" name="tone" value="promotional" class="d-none">
                    üì£ Promotional
                </label>
            </div>
        </div>
        
        <!-- Additional Context -->
        <div class="mb-4">
            <label class="form-label fw-bold" for="extra-context">Additional Instructions (optional)</label>
            <textarea class="form-control" id="extra-context" rows="2" 
                placeholder="Add any specific instructions, tone preferences, target audience details, key points to emphasize, or hashtags to include..."></textarea>
            <small class="text-muted">This context will be included in the AI prompt to guide post generation</small>
        </div>
        
        <!-- Generate Button -->
        <div class="d-grid">
            <button type="button" class="btn btn-lg text-white" id="generate-btn" 
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                    onclick="generatePosts()">
                ‚ú® Generate & Save Posts
            </button>
        </div>
        
        <!-- Loading Overlay -->
        <div class="generating-overlay d-none" id="generating-overlay">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <div class="fw-bold">Generating posts...</div>
            <div class="text-muted small">This may take a few seconds</div>
        </div>
    </div>
</div>

<!-- Saved Posts Section -->
{% if posts_by_platform %}
<div class="card mb-4" id="saved-posts-section">
    <div class="card-header bg-gradient d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
        <strong>üì¨ Generated Posts</strong>
        {% set total_posts = namespace(count=0) %}
        {% for platform, posts in posts_by_platform.items() %}
            {% set total_posts.count = total_posts.count + posts|length %}
        {% endfor %}
        <span class="badge bg-light text-dark" id="posts-count">{{ total_posts.count }} saved post{% if total_posts.count != 1 %}s{% endif %}</span>
    </div>
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h6 class="mb-0">üíæ Saved Posts</h6>
            <div class="d-flex gap-2 flex-wrap">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-select-mode" onclick="toggleSelectMode()">
                    ‚òëÔ∏è Select
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary d-none select-mode-btn" id="select-all-btn" onclick="selectAllPosts()">
                    ‚òëÔ∏è Select All
                </button>
                <button type="button" class="btn btn-sm btn-success d-none" id="queue-selected-btn" onclick="queueSelectedPosts()">
                    ‚ûï Add to Queue (<span id="queue-selected-count">0</span>)
                </button>
                <button type="button" class="btn btn-sm btn-danger d-none" id="delete-selected-btn" onclick="deleteSelectedPosts()">
                    üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)
                </button>
                <button type="button" class="btn btn-sm btn-primary" onclick="showQueueAllModal()">
                    üöÄ Queue All Unscheduled
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllPosts()">
                    üóëÔ∏è Clear All
                </button>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="d-flex gap-2 mb-3 flex-wrap align-items-center" id="posts-filter-bar">
            <span class="text-muted small">Filter:</span>
            <select class="form-select form-select-sm" style="width: auto;" id="filter-used" onchange="applyPostFilters()">
                <option value="">All Status</option>
                <option value="used">‚úì Used</option>
                <option value="unused">‚óã Unused</option>
            </select>
            <select class="form-select form-select-sm" style="width: auto;" id="filter-queued" onchange="applyPostFilters()">
                <option value="">All Queue</option>
                <option value="queued">‚úÖ Queued</option>
                <option value="not-queued">‚ûï Not Queued</option>
            </select>
            <select class="form-select form-select-sm" style="width: auto;" id="filter-platform" onchange="applyPostFilters()">
                <option value="">All Platforms</option>
                <option value="linkedin">üíº LinkedIn</option>
                <option value="threads">üßµ Threads</option>
            </select>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearPostFilters()" title="Clear Filters">‚úï</button>
            <span class="text-muted small ms-2" id="filter-results-count"></span>
        </div>
        
        <div id="saved-posts-container">
            {% for platform, posts in posts_by_platform.items() %}
            <div class="social-copy-card mb-3" data-platform="{{ platform }}">
                <div class="social-copy-header d-flex justify-content-between align-items-center" style="background-color: var(--platform-{{ platform }}-color, #6c757d)">
                    <div>
                        <span class="social-icon">
                            {% if platform == 'twitter' %}ùïè{% elif platform == 'linkedin' %}üíº{% elif platform == 'facebook' %}üìò{% elif platform == 'threads' %}üßµ{% elif platform == 'bluesky' %}ü¶ã{% elif platform == 'mastodon' %}üêò{% elif platform == 'instagram' %}üì∑{% else %}üì±{% endif %}
                        </span>
                        <span class="social-platform">{{ platform|capitalize }}</span>
                        <span class="badge bg-light text-dark ms-2">{{ posts|length }} post{% if posts|length != 1 %}s{% endif %}</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-light d-none select-mode-btn platform-select-all" 
                            onclick="selectPlatformPosts('{{ platform }}')" title="Select all {{ platform }} posts">
                        ‚òëÔ∏è All
                    </button>
                </div>
                <div class="social-copy-body" data-platform="{{ platform }}">
                    {% for post in posts %}
                    <div class="post-item {% if not loop.first %}mt-3 pt-3 border-top{% endif %}{% if loop.index > 3 %} d-none extra-post{% endif %}" data-post-id="{{ post.id }}" data-post-index="{{ loop.index }}">
                        <div class="d-flex justify-content-between align-items-center mb-2 post-header">
                            <div class="d-flex align-items-center gap-2">
                                <input type="checkbox" class="form-check-input post-select-checkbox d-none" 
                                       data-post-id="{{ post.id }}" onchange="updateSelectedCount()">
                                <span class="badge bg-secondary">Post {{ loop.index }}</span>
                                {% if post.used %}
                                <span class="badge bg-success used-badge">‚úì Used</span>
                                {% endif %}
                                {% if post.scheduled %}
                                    {% for sched_platform, sched_time in post.scheduled.items() %}
                                    <span class="badge {% if sched_platform == 'linkedin' %}text-bg-primary{% elif sched_platform == 'threads' %}text-bg-dark{% else %}bg-info{% endif %}" 
                                          title="{{ sched_time }}">
                                        üìÖ {{ sched_platform|capitalize }}
                                    </span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="btn-group btn-group-sm post-actions">
                                <button class="btn btn-outline-secondary" onclick="copySavedPost(this, {{ post.id }})" title="Copy">
                                    üìã
                                </button>
                                <button class="btn btn-outline-primary" onclick="editPost({{ post.id }})" title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-outline-{{ 'success' if post.used else 'secondary' }}" onclick="toggleUsed({{ post.id }}, this)" title="Mark as used">
                                    {% if post.used %}‚úì{% else %}‚óã{% endif %}
                                </button>
                                {% if platform == 'linkedin' %}
                                <button class="btn btn-outline-info linkedin-post-btn" onclick="postToLinkedIn({{ post.id }}, this)" title="Post to LinkedIn Now" data-post-id="{{ post.id }}">
                                    üíº
                                </button>
                                {% if post.scheduled and post.scheduled.linkedin %}
                                <button class="btn btn-success queue-toggle-btn" onclick="toggleQueue({{ post.id }}, 'standalone', 'linkedin', this, true)" title="Click to remove from queue (Scheduled: {{ post.scheduled.linkedin }})" data-post-id="{{ post.id }}" data-platform="linkedin" data-queued="true">
                                    ‚úÖ
                                </button>
                                {% else %}
                                <button class="btn btn-outline-success queue-toggle-btn" onclick="toggleQueue({{ post.id }}, 'standalone', 'linkedin', this, false)" title="Add to Queue" data-post-id="{{ post.id }}" data-platform="linkedin" data-queued="false">
                                    ‚ûï
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-warning" onclick="openScheduleModal({{ post.id }}, 'standalone', 'linkedin')" title="Schedule for Specific Time">
                                    üìÖ
                                </button>
                                {% elif platform == 'threads' %}
                                <button class="btn btn-outline-dark threads-post-btn" onclick="postToThreads({{ post.id }}, this)" title="Post to Threads Now" data-post-id="{{ post.id }}">
                                    üßµ
                                </button>
                                {% if post.scheduled and post.scheduled.threads %}
                                <button class="btn btn-success queue-toggle-btn" onclick="toggleQueue({{ post.id }}, 'standalone', 'threads', this, true)" title="Click to remove from queue (Scheduled: {{ post.scheduled.threads }})" data-post-id="{{ post.id }}" data-platform="threads" data-queued="true">
                                    ‚úÖ
                                </button>
                                {% else %}
                                <button class="btn btn-outline-success queue-toggle-btn" onclick="toggleQueue({{ post.id }}, 'standalone', 'threads', this, false)" title="Add to Queue" data-post-id="{{ post.id }}" data-platform="threads" data-queued="false">
                                    ‚ûï
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-warning" onclick="openScheduleModal({{ post.id }}, 'standalone', 'threads')" title="Schedule for Specific Time">
                                    üìÖ
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-danger" onclick="deletePost({{ post.id }}, this)" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div class="post-content-wrapper">
                            <pre class="social-copy-text" id="saved-post-{{ post.id }}">{{ post.content }}</pre>
                            <!-- Image attachment section -->
                            <div class="post-image-section mt-2" id="image-section-{{ post.id }}">
                                {% if post.image_url %}
                                <div class="d-flex align-items-center gap-2 mb-2" id="image-preview-{{ post.id }}">
                                    <img src="{{ post.image_url }}" alt="Post image" class="img-thumbnail" style="max-height: 60px; max-width: 100px; cursor: pointer;" onclick="openImageLightbox('{{ post.image_url }}')" title="Click to enlarge">
                                    <span class="text-muted small text-truncate" style="max-width: 200px;">{{ post.image_url }}</span>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editPostImage({{ post.id }})" title="Change Image">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removePostImage({{ post.id }})" title="Remove Image">
                                        ‚úï
                                    </button>
                                </div>
                                {% else %}
                                <div id="image-preview-{{ post.id }}" class="d-none">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <img src="" alt="Post image" class="img-thumbnail" style="max-height: 60px; max-width: 100px; cursor: pointer;" onclick="openImageLightbox(this.src)" title="Click to enlarge">
                                        <span class="text-muted small text-truncate" style="max-width: 200px;"></span>
                                        <button class="btn btn-sm btn-outline-warning" onclick="editPostImage({{ post.id }})" title="Change Image">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="removePostImage({{ post.id }})" title="Remove Image">
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="image-edit-form d-none" id="image-edit-form-{{ post.id }}">
                                    <!-- Image Source Tabs for Individual Post -->
                                    <ul class="nav nav-pills nav-fill mb-2" style="font-size: 0.75rem;">
                                        <li class="nav-item">
                                            <button class="nav-link active py-1 px-2" type="button" 
                                                onclick="switchPostImageTab({{ post.id }}, 'upload')" 
                                                id="post-upload-tab-{{ post.id }}">
                                                üìÅ Upload
                                            </button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link py-1 px-2" type="button" 
                                                onclick="switchPostImageTab({{ post.id }}, 'url')" 
                                                id="post-url-tab-{{ post.id }}">
                                                üîó URL
                                            </button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link py-1 px-2" type="button" 
                                                onclick="switchPostImageTab({{ post.id }}, 'library')" 
                                                id="post-library-tab-{{ post.id }}">
                                                üìö Library
                                            </button>
                                        </li>
                                    </ul>
                                    
                                    <!-- Upload File Pane -->
                                    <div id="post-upload-pane-{{ post.id }}">
                                        <div class="input-group input-group-sm">
                                            <input type="file" class="form-control form-control-sm" 
                                                id="image-file-input-{{ post.id }}"
                                                accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
                                                onchange="handlePostImageFileSelect({{ post.id }}, this)">
                                            <button class="btn btn-outline-secondary" type="button" onclick="cancelImageEdit({{ post.id }})">
                                                ‚úï
                                            </button>
                                        </div>
                                        <div id="post-upload-progress-{{ post.id }}" class="mt-1 d-none">
                                            <div class="progress" style="height: 16px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%; font-size: 0.7rem;">
                                                    Uploading...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- URL Pane -->
                                    <div id="post-url-pane-{{ post.id }}" class="d-none">
                                        <div class="input-group input-group-sm">
                                            <input type="url" class="form-control" id="image-url-input-{{ post.id }}" 
                                                   placeholder="https://example.com/image.jpg" value="{{ post.image_url or '' }}">
                                            <button class="btn btn-outline-secondary" type="button" onclick="previewPostImage({{ post.id }})" title="Preview">
                                                üëÅÔ∏è
                                            </button>
                                            <button class="btn btn-success" type="button" onclick="savePostImage({{ post.id }})">
                                                üíæ
                                            </button>
                                            <button class="btn btn-outline-secondary" type="button" onclick="cancelImageEdit({{ post.id }})">
                                                ‚úï
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Library Pane -->
                                    <div id="post-library-pane-{{ post.id }}" class="d-none">
                                        <div id="post-library-grid-{{ post.id }}" class="d-flex flex-wrap gap-1" style="max-height: 120px; overflow-y: auto;">
                                            <div class="text-muted small">Loading...</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden field for final URL -->
                                    <input type="hidden" id="post-final-image-url-{{ post.id }}" value="{{ post.image_url or '' }}">
                                </div>
                                {% if not post.image_url %}
                                <button class="btn btn-sm btn-outline-secondary add-image-btn" onclick="editPostImage({{ post.id }})" id="add-image-btn-{{ post.id }}">
                                    üñºÔ∏è Add Image
                                </button>
                                {% endif %}
                            </div>
                            <div class="edit-form d-none" id="edit-form-{{ post.id }}">
                                <textarea class="form-control mb-2" id="edit-textarea-{{ post.id }}" rows="4">{{ post.content }}</textarea>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="savePostEdit({{ post.id }})">
                                        üíæ Save
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="cancelPostEdit({{ post.id }})">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% if posts|length > 3 %}
                    <div class="text-center mt-3 pt-3 border-top show-more-container">
                        <button class="btn btn-sm btn-outline-secondary show-more-btn" onclick="toggleShowMore(this, '{{ platform }}')">
                            Show {{ posts|length - 3 }} more posts ‚ñº
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title">üìÖ Schedule Post</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="schedule-post-id">
                <input type="hidden" id="schedule-post-type">
                <input type="hidden" id="schedule-platform">
                <div class="mb-3">
                    <label class="form-label fw-bold">Select Date and Time</label>
                    <input type="datetime-local" class="form-control" id="schedule-datetime">
                </div>
                <div class="alert alert-info small">
                    <strong>Tip:</strong> Posts will be published automatically at the scheduled time. 
                    Make sure your platform connection is active.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="schedulePost()">üìÖ Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Queue All Modal -->
<div class="modal fade" id="queueAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                <h5 class="modal-title">üöÄ Queue All Unscheduled Posts</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Add all unscheduled posts to the queue? They will be assigned to the next available time slots.</p>
                <div class="d-flex gap-3 justify-content-center">
                    <div class="text-center">
                        <div class="fs-4 fw-bold text-primary" id="unscheduled-linkedin-count">0</div>
                        <div class="small text-muted">LinkedIn posts</div>
                    </div>
                    <div class="text-center">
                        <div class="fs-4 fw-bold text-dark" id="unscheduled-threads-count">0</div>
                        <div class="small text-muted">Threads posts</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="queueAllUnscheduled('linkedin')">
                    üíº Queue LinkedIn
                </button>
                <button type="button" class="btn btn-dark" onclick="queueAllUnscheduled('threads')">
                    üßµ Queue Threads
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Lightbox Modal -->
<div class="modal fade" id="imageLightboxModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background: transparent; border: none;">
            <div class="modal-body p-0 text-center">
                <img id="lightbox-image" src="" alt="Image preview" class="img-fluid" style="max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2" data-bs-dismiss="modal" aria-label="Close" style="background-color: rgba(0,0,0,0.5); padding: 10px; border-radius: 50%;"></button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let linkedinConnected = false;
let threadsConnected = false;
let selectModeActive = false;

// Image lightbox function
function openImageLightbox(imageUrl) {
    const lightboxImage = document.getElementById('lightbox-image');
    lightboxImage.src = imageUrl;
    new bootstrap.Modal(document.getElementById('imageLightboxModal')).show();
}

document.addEventListener('DOMContentLoaded', function() {
    checkLinkedInStatus();
    checkThreadsStatus();
    
    // Platform checkbox toggle
    document.querySelectorAll('.platform-checkbox-box').forEach(box => {
        box.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            this.classList.toggle('selected', checkbox.checked);
        });
    });
    
    // Tone option toggle
    document.querySelectorAll('.tone-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.tone-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            this.querySelector('input').checked = true;
        });
    });
});

function checkLinkedInStatus() {
    fetch('{{ url_for("linkedin_status") }}')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('linkedin-status-badge');
            const content = document.getElementById('linkedin-status-content');
            
            if (data.connected && !data.needs_configuration) {
                linkedinConnected = true;
                badge.className = 'badge bg-success';
                badge.textContent = 'Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>${data.display_name || 'LinkedIn User'}</strong></span>
                        <a href="{{ url_for('linkedin_disconnect') }}" class="btn btn-sm btn-outline-danger" 
                           onclick="return confirm('Disconnect LinkedIn?');">Disconnect</a>
                    </div>
                `;
            } else if (data.connected && data.needs_configuration) {
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Needs Setup';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-warning">Member ID needed</span>
                        <a href="{{ url_for('linkedin_configure') }}" class="btn btn-sm btn-warning">Configure</a>
                    </div>
                `;
            } else if (data.configured) {
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Not Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Connect to post to LinkedIn</span>
                        <a href="{{ url_for('linkedin_auth') }}" class="btn btn-sm btn-primary">Connect</a>
                    </div>
                `;
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Not Configured';
                content.innerHTML = '<small class="text-muted">Set LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET</small>';
            }
        })
        .catch(() => {
            document.getElementById('linkedin-status-badge').textContent = 'Error';
        });
}

function checkThreadsStatus() {
    fetch('{{ url_for("threads_status") }}')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('threads-status-badge');
            const content = document.getElementById('threads-status-content');
            
            if (data.connected) {
                threadsConnected = true;
                badge.className = 'badge bg-success';
                badge.textContent = 'Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>@${data.username || 'Threads User'}</strong></span>
                        <button class="btn btn-sm btn-outline-danger" onclick="disconnectThreads()">Disconnect</button>
                    </div>
                `;
            } else if (data.configured) {
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'Not Connected';
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Connect to post to Threads</span>
                        <a href="{{ url_for('threads_auth') }}" class="btn btn-sm btn-dark">Connect</a>
                    </div>
                `;
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Not Configured';
                content.innerHTML = '<small class="text-muted">Set THREADS_APP_ID and THREADS_APP_SECRET</small>';
            }
        })
        .catch(() => {
            document.getElementById('threads-status-badge').textContent = 'Error';
        });
}

function disconnectThreads() {
    if (!confirm('Disconnect Threads?')) return;
    fetch('{{ url_for("threads_disconnect") }}', { method: 'POST' })
        .then(() => {
            threadsConnected = false;
            checkThreadsStatus();
        });
}

function adjustPostCount(delta) {
    const input = document.getElementById('posts-per-platform');
    let value = parseInt(input.value) || 1;
    value = Math.max(1, Math.min(10, value + delta));
    input.value = value;
}

function previewBulkImage() {
    const input = document.getElementById('bulk-image-url');
    const preview = document.getElementById('bulk-image-preview');
    const img = preview.querySelector('img');
    const filenameSpan = document.getElementById('bulk-image-filename');
    
    if (input.value.trim()) {
        img.src = input.value.trim();
        img.onerror = function() {
            preview.classList.add('d-none');
            document.getElementById('final-image-url').value = '';
            showToast('Could not load image. Make sure the URL is valid and publicly accessible.', 'error');
        };
        img.onload = function() {
            preview.classList.remove('d-none');
            filenameSpan.textContent = '';
            // Store URL in hidden field
            document.getElementById('final-image-url').value = input.value.trim();
        };
    } else {
        preview.classList.add('d-none');
        document.getElementById('final-image-url').value = '';
    }
}

function clearBulkImage() {
    document.getElementById('bulk-image-url').value = '';
    document.getElementById('bulk-image-preview').classList.add('d-none');
    document.getElementById('bulk-image-filename').textContent = '';
    document.getElementById('final-image-url').value = '';
}

function handleImageFileSelect(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file type
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showToast('Invalid file type. Please upload PNG, JPG, GIF, or WebP.', 'error');
        input.value = '';
        return;
    }
    
    // Validate file size (16MB max)
    if (file.size > 16 * 1024 * 1024) {
        showToast('File too large. Maximum size is 16MB.', 'error');
        input.value = '';
        return;
    }
    
    // Show upload progress
    document.getElementById('upload-progress').classList.remove('d-none');
    
    // Upload the file
    const formData = new FormData();
    formData.append('image', file);
    
    fetch('{{ url_for("compose_upload_image") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('upload-progress').classList.add('d-none');
        
        if (data.success) {
            // Store the URL in hidden field
            document.getElementById('final-image-url').value = data.image_url;
            
            // Show preview
            const preview = document.getElementById('bulk-image-preview');
            const img = preview.querySelector('img');
            const filenameSpan = document.getElementById('bulk-image-filename');
            
            img.src = data.image_url;
            filenameSpan.textContent = file.name;
            preview.classList.remove('d-none');
            
            showToast('Image uploaded successfully!', 'success');
            
            // Show warning if image stored locally (won't work with Threads)
            if (data.warning) {
                showToast(data.warning, 'warning');
            }
        } else {
            showToast('Upload failed: ' + (data.error || 'Unknown error'), 'error');
            input.value = '';
        }
    })
    .catch(error => {
        document.getElementById('upload-progress').classList.add('d-none');
        showToast('Upload failed: ' + error.message, 'error');
        input.value = '';
    });
}

function clearBulkImageFile() {
    document.getElementById('bulk-image-file').value = '';
    document.getElementById('bulk-image-preview').classList.add('d-none');
    document.getElementById('bulk-image-filename').textContent = '';
    document.getElementById('final-image-url').value = '';
}

function getActiveSourceType() {
    const activeTab = document.querySelector('#sourceTypeTabs .nav-link.active');
    if (activeTab.id === 'freeform-tab') return 'freeform';
    if (activeTab.id === 'url-tab') return 'url';
    if (activeTab.id === 'text-tab') return 'text';
    if (activeTab.id === 'saved-tab') return 'saved_source';
    return 'freeform';
}

function getContent() {
    const sourceType = getActiveSourceType();
    if (sourceType === 'freeform') return document.getElementById('freeform-input').value.trim();
    if (sourceType === 'url') return document.getElementById('url-input').value.trim();
    if (sourceType === 'text') return document.getElementById('text-input').value.trim();
    if (sourceType === 'saved_source') {
        const select = document.getElementById('saved-source-select');
        return select ? select.value : '';
    }
    return '';
}

function onSourceSelected() {
    const select = document.getElementById('saved-source-select');
    const preview = document.getElementById('source-preview');
    const option = select.options[select.selectedIndex];
    
    if (select.value) {
        document.getElementById('preview-title').textContent = option.dataset.title || 'Untitled';
        document.getElementById('preview-description').textContent = option.dataset.description || '';
        document.getElementById('preview-url').textContent = option.dataset.url || '';
        document.getElementById('preview-url').href = option.dataset.url || '#';
        preview.classList.remove('d-none');
    } else {
        preview.classList.add('d-none');
    }
}

function generatePosts() {
    const sourceType = getActiveSourceType();
    const content = getContent();
    
    if (!content) {
        if (sourceType === 'saved_source') {
            alert('Please select a saved source');
        } else {
            alert('Please enter content to generate posts from');
        }
        return;
    }
    
    const checkboxes = document.querySelectorAll('#platform-checkboxes input:checked');
    const platforms = Array.from(checkboxes).map(cb => cb.value);
    if (platforms.length === 0) {
        alert('Please select at least one platform');
        return;
    }
    
    const tone = document.querySelector('.tone-option.selected input').value;
    const postsPerPlatform = parseInt(document.getElementById('posts-per-platform').value) || 1;
    const extraContext = document.getElementById('extra-context').value.trim();
    const topic = document.getElementById('text-topic')?.value?.trim() || '';
    
    // Show loading
    document.getElementById('generating-overlay').classList.remove('d-none');
    document.getElementById('generate-btn').disabled = true;
    
    const formData = new FormData();
    formData.append('tone', tone);
    formData.append('posts_per_platform', postsPerPlatform);
    if (extraContext) formData.append('extra_context', extraContext);
    platforms.forEach(p => formData.append('platforms', p));
    
    // Include image URL if provided (from upload or URL input)
    const finalImageUrl = document.getElementById('final-image-url').value.trim();
    if (finalImageUrl) {
        formData.append('image_url', finalImageUrl);
    }
    
    // Use different endpoint for saved sources
    let endpoint;
    if (sourceType === 'saved_source') {
        formData.append('source_id', content);
        endpoint = '{{ url_for("compose_generate_from_source") }}';
    } else {
        formData.append('source_type', sourceType);
        formData.append('content', content);
        if (topic) formData.append('topic', topic);
        endpoint = '{{ url_for("compose_generate") }}';
    }
    
    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('generating-overlay').classList.add('d-none');
        document.getElementById('generate-btn').disabled = false;
        
        if (data.success) {
            showToast('Posts generated and saved! Refreshing...', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Error: ' + (data.error || 'Failed to generate posts'));
        }
    })
    .catch(error => {
        document.getElementById('generating-overlay').classList.add('d-none');
        document.getElementById('generate-btn').disabled = false;
        alert('Error: ' + error.message);
    });
}

function copySavedPost(btn, postId) {
    const text = document.getElementById(`saved-post-${postId}`).textContent;
    navigator.clipboard.writeText(text).then(() => {
        const original = btn.innerHTML;
        btn.innerHTML = '‚úì';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = original;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

function editPost(postId) {
    const textEl = document.getElementById(`saved-post-${postId}`);
    const formEl = document.getElementById(`edit-form-${postId}`);
    const textarea = document.getElementById(`edit-textarea-${postId}`);
    
    textEl.classList.add('d-none');
    formEl.classList.remove('d-none');
    textarea.focus();
}

function cancelPostEdit(postId) {
    const textEl = document.getElementById(`saved-post-${postId}`);
    const formEl = document.getElementById(`edit-form-${postId}`);
    const textarea = document.getElementById(`edit-textarea-${postId}`);
    
    // Reset textarea to original
    textarea.value = textEl.textContent;
    
    textEl.classList.remove('d-none');
    formEl.classList.add('d-none');
}

// Image management functions
function editPostImage(postId) {
    const editForm = document.getElementById(`image-edit-form-${postId}`);
    const addBtn = document.getElementById(`add-image-btn-${postId}`);
    
    // Reset to upload tab by default
    switchPostImageTab(postId, 'upload');
    
    // Clear file input
    const fileInput = document.getElementById(`image-file-input-${postId}`);
    if (fileInput) fileInput.value = '';
    
    editForm.classList.remove('d-none');
    if (addBtn) addBtn.classList.add('d-none');
}

function cancelImageEdit(postId) {
    const editForm = document.getElementById(`image-edit-form-${postId}`);
    const addBtn = document.getElementById(`add-image-btn-${postId}`);
    const preview = document.getElementById(`image-preview-${postId}`);
    
    // Clear file input
    const fileInput = document.getElementById(`image-file-input-${postId}`);
    if (fileInput) fileInput.value = '';
    
    // Hide upload progress if visible
    const uploadProgress = document.getElementById(`post-upload-progress-${postId}`);
    if (uploadProgress) uploadProgress.classList.add('d-none');
    
    editForm.classList.add('d-none');
    
    // Show add button only if no image is currently set
    if (addBtn && preview.classList.contains('d-none')) {
        addBtn.classList.remove('d-none');
    }
}

function previewPostImage(postId) {
    const input = document.getElementById(`image-url-input-${postId}`);
    const preview = document.getElementById(`image-preview-${postId}`);
    const img = preview.querySelector('img');
    
    if (input.value.trim()) {
        img.src = input.value.trim();
        img.onerror = function() {
            showToast('Could not load image. Make sure the URL is valid.', 'error');
        };
        img.onload = function() {
            preview.classList.remove('d-none');
            preview.querySelector('span').textContent = input.value.trim();
        };
    }
}

function savePostImage(postId) {
    const input = document.getElementById(`image-url-input-${postId}`);
    const imageUrl = input.value.trim();
    
    fetch(`/compose/post/${postId}/image`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `image_url=${encodeURIComponent(imageUrl)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const preview = document.getElementById(`image-preview-${postId}`);
            const editForm = document.getElementById(`image-edit-form-${postId}`);
            const addBtn = document.getElementById(`add-image-btn-${postId}`);
            
            if (imageUrl) {
                preview.querySelector('img').src = imageUrl;
                preview.querySelector('span').textContent = imageUrl;
                preview.classList.remove('d-none');
                if (addBtn) addBtn.classList.add('d-none');
            } else {
                preview.classList.add('d-none');
                if (addBtn) addBtn.classList.remove('d-none');
            }
            
            editForm.classList.add('d-none');
            showToast(imageUrl ? 'Image saved!' : 'Image removed!', 'success');
        } else {
            showToast('Error: ' + (data.error || 'Failed to save image'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

function removePostImage(postId) {
    if (!confirm('Remove the image from this post?')) return;
    
    document.getElementById(`image-url-input-${postId}`).value = '';
    document.getElementById(`post-final-image-url-${postId}`).value = '';
    savePostImage(postId);
}

// Image library functions
let cachedImages = null;

function loadImageLibrary(context, postId = null) {
    const gridId = context === 'bulk' ? 'image-library-grid' : `post-library-grid-${postId}`;
    const grid = document.getElementById(gridId);
    
    if (!grid) return;
    
    // Use cached images if available
    if (cachedImages) {
        renderImageGrid(grid, cachedImages, context, postId);
        return;
    }
    
    grid.innerHTML = '<div class="text-muted small">Loading images...</div>';
    
    fetch('/compose/list-images')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cachedImages = data.images;
                renderImageGrid(grid, data.images, context, postId);
            } else {
                grid.innerHTML = '<div class="text-muted small">Failed to load images</div>';
            }
        })
        .catch(error => {
            grid.innerHTML = '<div class="text-muted small">Error loading images</div>';
        });
}

function renderImageGrid(grid, images, context, postId) {
    if (images.length === 0) {
        grid.innerHTML = '<div class="text-muted small">No uploaded images yet</div>';
        return;
    }
    
    grid.innerHTML = images.map(img => `
        <img src="${img.url}" 
             class="img-thumbnail library-image" 
             style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;"
             onclick="selectLibraryImage('${img.url}', '${context}', ${postId || 'null'})"
             title="${img.filename}">
    `).join('');
}

function selectLibraryImage(url, context, postId) {
    if (context === 'bulk') {
        // Set the URL in the hidden field
        document.getElementById('final-image-url').value = url;
        
        // Show preview
        const preview = document.getElementById('bulk-image-preview');
        const img = preview.querySelector('img');
        img.src = url;
        document.getElementById('bulk-image-filename').textContent = 'From library';
        preview.classList.remove('d-none');
        
        showToast('Image selected from library', 'success');
    } else {
        // Individual post - save directly
        document.getElementById(`image-url-input-${postId}`).value = url;
        document.getElementById(`post-final-image-url-${postId}`).value = url;
        savePostImageWithUrl(postId, url);
        showToast('Image selected and saved!', 'success');
    }
}

function switchPostImageTab(postId, tab) {
    const uploadTab = document.getElementById(`post-upload-tab-${postId}`);
    const urlTab = document.getElementById(`post-url-tab-${postId}`);
    const libraryTab = document.getElementById(`post-library-tab-${postId}`);
    const uploadPane = document.getElementById(`post-upload-pane-${postId}`);
    const urlPane = document.getElementById(`post-url-pane-${postId}`);
    const libraryPane = document.getElementById(`post-library-pane-${postId}`);
    
    // Reset all tabs
    [uploadTab, urlTab, libraryTab].forEach(t => t && t.classList.remove('active'));
    [uploadPane, urlPane, libraryPane].forEach(p => p && p.classList.add('d-none'));
    
    if (tab === 'upload') {
        uploadTab.classList.add('active');
        uploadPane.classList.remove('d-none');
    } else if (tab === 'url') {
        urlTab.classList.add('active');
        urlPane.classList.remove('d-none');
        document.getElementById(`image-url-input-${postId}`).focus();
    } else if (tab === 'library') {
        libraryTab.classList.add('active');
        libraryPane.classList.remove('d-none');
        loadImageLibrary('post', postId);
    }
}

function handlePostImageFileSelect(postId, input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file type
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showToast('Invalid file type. Please upload PNG, JPG, GIF, or WebP.', 'error');
        input.value = '';
        return;
    }
    
    // Validate file size (16MB max)
    if (file.size > 16 * 1024 * 1024) {
        showToast('File too large. Maximum size is 16MB.', 'error');
        input.value = '';
        return;
    }
    
    // Show upload progress
    document.getElementById(`post-upload-progress-${postId}`).classList.remove('d-none');
    
    // Upload the file
    const formData = new FormData();
    formData.append('image', file);
    
    fetch('{{ url_for("compose_upload_image") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`post-upload-progress-${postId}`).classList.add('d-none');
        
        if (data.success) {
            // Store the URL and save to the post
            document.getElementById(`image-url-input-${postId}`).value = data.image_url;
            document.getElementById(`post-final-image-url-${postId}`).value = data.image_url;
            
            // Save the image to the post
            savePostImageWithUrl(postId, data.image_url);
            
            showToast('Image uploaded and saved!', 'success');
            
            // Show warning if image stored locally (won't work with Threads)
            if (data.warning) {
                showToast(data.warning, 'warning');
            }
        } else {
            showToast('Upload failed: ' + (data.error || 'Unknown error'), 'error');
            input.value = '';
        }
    })
    .catch(error => {
        document.getElementById(`post-upload-progress-${postId}`).classList.add('d-none');
        showToast('Upload failed: ' + error.message, 'error');
        input.value = '';
    });
}

function savePostImageWithUrl(postId, imageUrl) {
    fetch(`/compose/post/${postId}/image`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `image_url=${encodeURIComponent(imageUrl)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const preview = document.getElementById(`image-preview-${postId}`);
            const editForm = document.getElementById(`image-edit-form-${postId}`);
            const addBtn = document.getElementById(`add-image-btn-${postId}`);
            
            if (imageUrl) {
                preview.querySelector('img').src = imageUrl;
                preview.querySelector('span').textContent = imageUrl;
                preview.classList.remove('d-none');
                if (addBtn) addBtn.classList.add('d-none');
            } else {
                preview.classList.add('d-none');
                if (addBtn) addBtn.classList.remove('d-none');
            }
            
            editForm.classList.add('d-none');
        } else {
            showToast('Error: ' + (data.error || 'Failed to save image'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

function savePostEdit(postId) {
    const textarea = document.getElementById(`edit-textarea-${postId}`);
    const content = textarea.value.trim();
    
    if (!content) {
        alert('Content cannot be empty');
        return;
    }
    
    const formData = new FormData();
    formData.append('content', content);
    
    fetch(`/compose/post/${postId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const textEl = document.getElementById(`saved-post-${postId}`);
            const formEl = document.getElementById(`edit-form-${postId}`);
            
            textEl.textContent = content;
            textEl.classList.remove('d-none');
            formEl.classList.add('d-none');
            showToast('Post updated!', 'success');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function toggleUsed(postId, btn) {
    fetch(`/compose/post/${postId}/toggle-used`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const postItem = btn.closest('.post-item');
                const usedBadge = postItem.querySelector('.used-badge');
                
                if (data.used) {
                    btn.innerHTML = '‚úì';
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-outline-success');
                    if (!usedBadge) {
                        const badgeContainer = postItem.querySelector('.d-flex.align-items-center.gap-2');
                        const newBadge = document.createElement('span');
                        newBadge.className = 'badge bg-success used-badge';
                        newBadge.textContent = '‚úì Used';
                        badgeContainer.appendChild(newBadge);
                    }
                } else {
                    btn.innerHTML = '‚óã';
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-outline-secondary');
                    if (usedBadge) usedBadge.remove();
                }
            }
        });
}

function deletePost(postId, btn) {
    if (!confirm('Delete this post?')) return;
    
    fetch(`/compose/post/${postId}/delete`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const postItem = btn.closest('.post-item');
                const card = postItem.closest('.social-copy-card');
                const allPosts = card.querySelectorAll('.post-item');
                
                if (allPosts.length === 1) {
                    card.remove();
                    const container = document.getElementById('saved-posts-container');
                    if (container && container.children.length === 0) {
                        document.getElementById('saved-posts-section').remove();
                    }
                } else {
                    postItem.remove();
                    const remainingPosts = card.querySelectorAll('.post-item');
                    remainingPosts.forEach((p, i) => {
                        const badge = p.querySelector('.badge.bg-secondary');
                        if (badge) badge.textContent = `Post ${i + 1}`;
                        p.classList.remove('mt-3', 'pt-3', 'border-top');
                        if (i > 0) p.classList.add('mt-3', 'pt-3', 'border-top');
                    });
                    const countBadge = card.querySelector('.social-copy-header .badge');
                    if (countBadge) {
                        countBadge.textContent = `${remainingPosts.length} post${remainingPosts.length !== 1 ? 's' : ''}`;
                    }
                }
                showToast('Post deleted', 'success');
            }
        });
}

function toggleShowMore(btn, platform) {
    const body = btn.closest('.social-copy-body');
    const extraPosts = body.querySelectorAll('.extra-post');
    const isExpanded = btn.dataset.expanded === 'true';
    
    if (isExpanded) {
        extraPosts.forEach(post => post.classList.add('d-none'));
        btn.innerHTML = `Show ${extraPosts.length} more posts ‚ñº`;
        btn.dataset.expanded = 'false';
        body.closest('.social-copy-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        extraPosts.forEach(post => post.classList.remove('d-none'));
        btn.innerHTML = `Show less ‚ñ≤`;
        btn.dataset.expanded = 'true';
    }
}

function postToLinkedIn(postId, btn) {
    if (!linkedinConnected) {
        alert('Please connect LinkedIn first');
        return;
    }
    if (!confirm('Post to LinkedIn now?')) return;
    
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥';
    btn.disabled = true;
    
    fetch(`/compose/post/${postId}/linkedin`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.innerHTML = '‚úÖ';
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-success');
                showToast('Posted to LinkedIn!', 'success');
                // Mark as used
                const postItem = btn.closest('.post-item');
                const usedBtn = postItem.querySelector('button[title="Mark as used"]');
                if (usedBtn && !usedBtn.classList.contains('btn-outline-success')) {
                    toggleUsed(postId, usedBtn);
                }
            } else {
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('Error: ' + (data.error || 'Failed to post'));
            }
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Error: ' + error.message);
        });
}

function postToThreads(postId, btn) {
    if (!threadsConnected) {
        alert('Please connect Threads first');
        return;
    }
    if (!confirm('Post to Threads now?')) return;
    
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥';
    btn.disabled = true;
    
    fetch(`/compose/post/${postId}/threads`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.innerHTML = '‚úÖ';
                btn.classList.remove('btn-outline-dark');
                btn.classList.add('btn-success');
                showToast('Posted to Threads!', 'success');
                // Mark as used
                const postItem = btn.closest('.post-item');
                const usedBtn = postItem.querySelector('button[title="Mark as used"]');
                if (usedBtn && !usedBtn.classList.contains('btn-outline-success')) {
                    toggleUsed(postId, usedBtn);
                }
            } else {
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('Error: ' + (data.error || 'Failed to post'));
            }
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Error: ' + error.message);
        });
}

function toggleQueue(postId, postType, platform, btn, isQueued) {
    if (platform === 'linkedin' && !linkedinConnected) {
        alert('Please connect LinkedIn first');
        return;
    }
    if (platform === 'threads' && !threadsConnected) {
        alert('Please connect Threads first');
        return;
    }
    
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥';
    btn.disabled = true;
    
    if (isQueued) {
        // Remove from queue
        const formData = new FormData();
        formData.append('post_type', postType);
        formData.append('post_id', postId);
        formData.append('platform', platform);
        
        fetch('/schedule/remove-from-queue', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            if (data.success) {
                btn.innerHTML = '‚ûï';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
                btn.setAttribute('data-queued', 'false');
                btn.title = 'Add to Queue';
                btn.onclick = function() { toggleQueue(postId, postType, platform, btn, false); };
                showToast(data.message, 'success');
            } else {
                btn.innerHTML = originalText;
                alert('Error: ' + (data.error || 'Failed to remove from queue'));
            }
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Error: ' + error.message);
        });
    } else {
        // Add to queue
        const formData = new FormData();
        formData.append('platform', platform);
        formData.append('post_type', postType);
        
        fetch(`/compose/post/${postId}/queue`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            if (data.success) {
                btn.innerHTML = '‚úÖ';
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-success');
                btn.setAttribute('data-queued', 'true');
                btn.title = 'Click to remove from queue';
                btn.onclick = function() { toggleQueue(postId, postType, platform, btn, true); };
                showToast(data.message, 'success');
            } else {
                btn.innerHTML = originalText;
                alert('Error: ' + (data.error || 'Failed to add to queue'));
            }
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Error: ' + error.message);
        });
    }
}

// Legacy function for backwards compatibility
function addToQueue(postId, postType, platform, btn) {
    toggleQueue(postId, postType, platform, btn, false);
}

function openScheduleModal(postId, postType, platform) {
    if (platform === 'linkedin' && !linkedinConnected) {
        alert('Please connect LinkedIn first');
        return;
    }
    if (platform === 'threads' && !threadsConnected) {
        alert('Please connect Threads first');
        return;
    }
    
    document.getElementById('schedule-post-id').value = postId;
    document.getElementById('schedule-post-type').value = postType;
    document.getElementById('schedule-platform').value = platform;
    
    // Set default datetime to next hour
    const now = new Date();
    now.setHours(now.getHours() + 1);
    now.setMinutes(0);
    now.setSeconds(0);
    const dateStr = now.toISOString().slice(0, 16);
    document.getElementById('schedule-datetime').value = dateStr;
    
    new bootstrap.Modal(document.getElementById('scheduleModal')).show();
}

function schedulePost() {
    const postId = document.getElementById('schedule-post-id').value;
    const postType = document.getElementById('schedule-post-type').value;
    const platform = document.getElementById('schedule-platform').value;
    const datetime = document.getElementById('schedule-datetime').value;
    
    if (!datetime) {
        alert('Please select a date and time');
        return;
    }
    
    const formData = new FormData();
    formData.append('platform', platform);
    formData.append('post_type', postType);
    formData.append('scheduled_for', datetime);
    
    fetch(`/compose/post/${postId}/queue`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
            showToast(`Scheduled for ${data.scheduled_for_display}`, 'success');
            // Update the queue button
            const queueBtn = document.querySelector(`.post-item[data-post-id="${postId}"] .btn-outline-success[data-platform="${platform}"]`);
            if (queueBtn) {
                queueBtn.innerHTML = '‚úÖ';
                queueBtn.classList.remove('btn-outline-success');
                queueBtn.classList.add('btn-success');
                queueBtn.disabled = true;
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to schedule'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// Select mode functions
function toggleSelectMode() {
    selectModeActive = !selectModeActive;
    const checkboxes = document.querySelectorAll('.post-select-checkbox');
    const toggleBtn = document.getElementById('toggle-select-mode');
    const deleteBtn = document.getElementById('delete-selected-btn');
    const selectModeBtns = document.querySelectorAll('.select-mode-btn');
    
    if (selectModeActive) {
        checkboxes.forEach(cb => cb.classList.remove('d-none'));
        selectModeBtns.forEach(btn => btn.classList.remove('d-none'));
        toggleBtn.classList.remove('btn-outline-secondary');
        toggleBtn.classList.add('btn-secondary');
        toggleBtn.innerHTML = '‚úï Cancel';
    } else {
        checkboxes.forEach(cb => {
            cb.classList.add('d-none');
            cb.checked = false;
        });
        selectModeBtns.forEach(btn => btn.classList.add('d-none'));
        toggleBtn.classList.remove('btn-secondary');
        toggleBtn.classList.add('btn-outline-secondary');
        toggleBtn.innerHTML = '‚òëÔ∏è Select';
        deleteBtn.classList.add('d-none');
    }
    updateSelectedCount();
}

function selectAllPosts() {
    const checkboxes = document.querySelectorAll('.post-select-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateSelectedCount();
    const btn = document.getElementById('select-all-btn');
    btn.innerHTML = allChecked ? '‚òëÔ∏è Select All' : '‚òê Deselect All';
}

function selectPlatformPosts(platform) {
    const card = document.querySelector(`.social-copy-card[data-platform="${platform}"]`);
    if (!card) return;
    const checkboxes = card.querySelectorAll('.post-select-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const allCheckboxes = document.querySelectorAll('.post-select-checkbox');
    const selected = document.querySelectorAll('.post-select-checkbox:checked');
    const count = selected.length;
    document.getElementById('selected-count').textContent = count;
    
    const deleteBtn = document.getElementById('delete-selected-btn');
    const queueBtn = document.getElementById('queue-selected-btn');
    
    if (count > 0 && selectModeActive) {
        deleteBtn.classList.remove('d-none');
        
        let queueableCount = 0;
        selected.forEach(cb => {
            const card = cb.closest('.social-copy-card');
            const platform = card ? card.dataset.platform : '';
            if (platform === 'linkedin' || platform === 'threads') {
                queueableCount++;
            }
        });
        
        document.getElementById('queue-selected-count').textContent = queueableCount;
        if (queueableCount > 0) {
            queueBtn.classList.remove('d-none');
        } else {
            queueBtn.classList.add('d-none');
        }
    } else {
        deleteBtn.classList.add('d-none');
        queueBtn.classList.add('d-none');
    }
    
    const selectAllBtn = document.getElementById('select-all-btn');
    if (selectAllBtn) {
        const allChecked = allCheckboxes.length > 0 && allCheckboxes.length === selected.length;
        selectAllBtn.innerHTML = allChecked ? '‚òê Deselect All' : '‚òëÔ∏è Select All';
    }
}

function deleteSelectedPosts() {
    const selected = document.querySelectorAll('.post-select-checkbox:checked');
    const postIds = Array.from(selected).map(cb => parseInt(cb.dataset.postId));
    
    if (postIds.length === 0) {
        alert('No posts selected');
        return;
    }
    
    if (!confirm(`Delete ${postIds.length} selected post${postIds.length !== 1 ? 's' : ''}? This cannot be undone.`)) {
        return;
    }
    
    fetch('/compose/posts/delete-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_ids: postIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            postIds.forEach(postId => {
                const postItem = document.querySelector(`.post-item[data-post-id="${postId}"]`);
                if (postItem) {
                    const card = postItem.closest('.social-copy-card');
                    const allPosts = card.querySelectorAll('.post-item');
                    if (allPosts.length === 1) {
                        card.remove();
                    } else {
                        postItem.remove();
                    }
                }
            });
            
            document.querySelectorAll('.social-copy-card').forEach(card => {
                const remainingPosts = card.querySelectorAll('.post-item');
                if (remainingPosts.length === 0) {
                    card.remove();
                } else {
                    remainingPosts.forEach((p, i) => {
                        const badge = p.querySelector('.badge.bg-secondary');
                        if (badge) badge.textContent = `Post ${i + 1}`;
                        p.classList.remove('mt-3', 'pt-3', 'border-top');
                        if (i > 0) p.classList.add('mt-3', 'pt-3', 'border-top');
                    });
                    const countBadge = card.querySelector('.social-copy-header .badge');
                    if (countBadge) {
                        countBadge.textContent = `${remainingPosts.length} post${remainingPosts.length !== 1 ? 's' : ''}`;
                    }
                }
            });
            
            const container = document.getElementById('saved-posts-container');
            if (container && container.children.length === 0) {
                document.getElementById('saved-posts-section').remove();
            }
            
            toggleSelectMode();
            showToast(`Deleted ${data.deleted_count} posts`, 'success');
        } else {
            alert('Error: ' + (data.error || 'Failed to delete posts'));
        }
    });
}

async function queueSelectedPosts() {
    const selected = document.querySelectorAll('.post-select-checkbox:checked');
    
    const postsToQueue = [];
    selected.forEach(cb => {
        const card = cb.closest('.social-copy-card');
        const platform = card ? card.dataset.platform : '';
        if (platform === 'linkedin' || platform === 'threads') {
            postsToQueue.push({
                postId: parseInt(cb.dataset.postId),
                platform: platform,
                btn: cb.closest('.post-item').querySelector('.btn-outline-success')
            });
        }
    });
    
    if (postsToQueue.length === 0) {
        alert('No queueable posts selected (only LinkedIn and Threads posts can be queued)');
        return;
    }
    
    if ((postsToQueue.some(p => p.platform === 'linkedin') && !linkedinConnected) ||
        (postsToQueue.some(p => p.platform === 'threads') && !threadsConnected)) {
        alert('Please connect the required platforms first');
        return;
    }
    
    const queueBtn = document.getElementById('queue-selected-btn');
    const originalText = queueBtn.innerHTML;
    queueBtn.innerHTML = '‚è≥ Adding...';
    queueBtn.disabled = true;
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const post of postsToQueue) {
        try {
            const formData = new FormData();
            formData.append('platform', post.platform);
            
            const response = await fetch(`/compose/post/${post.postId}/queue`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.success) {
                successCount++;
                if (post.btn) {
                    post.btn.innerHTML = '‚úÖ';
                    post.btn.classList.remove('btn-outline-success');
                    post.btn.classList.add('btn-success');
                    post.btn.disabled = true;
                }
            } else {
                errorCount++;
            }
        } catch (e) {
            errorCount++;
        }
    }
    
    queueBtn.innerHTML = originalText;
    queueBtn.disabled = false;
    
    if (errorCount === 0) {
        showToast(`Added ${successCount} post${successCount !== 1 ? 's' : ''} to queue`, 'success');
    } else {
        showToast(`Added ${successCount}, failed ${errorCount}`, errorCount > successCount ? 'error' : 'warning');
    }
    
    toggleSelectMode();
}

function showQueueAllModal() {
    let linkedinCount = 0;
    let threadsCount = 0;
    
    document.querySelectorAll('.social-copy-card[data-platform="linkedin"] .post-item').forEach(item => {
        const queueBtn = item.querySelector('.btn-outline-success[data-platform="linkedin"]');
        const usedBadge = item.querySelector('.used-badge');
        if (queueBtn && !queueBtn.disabled && !usedBadge) linkedinCount++;
    });
    
    document.querySelectorAll('.social-copy-card[data-platform="threads"] .post-item').forEach(item => {
        const queueBtn = item.querySelector('.btn-outline-success[data-platform="threads"]');
        const usedBadge = item.querySelector('.used-badge');
        if (queueBtn && !queueBtn.disabled && !usedBadge) threadsCount++;
    });
    
    document.getElementById('unscheduled-linkedin-count').textContent = linkedinCount;
    document.getElementById('unscheduled-threads-count').textContent = threadsCount;
    
    new bootstrap.Modal(document.getElementById('queueAllModal')).show();
}

async function queueAllUnscheduled(platform) {
    if (platform === 'linkedin' && !linkedinConnected) {
        alert('Please connect LinkedIn first');
        return;
    }
    if (platform === 'threads' && !threadsConnected) {
        alert('Please connect Threads first');
        return;
    }
    
    const postsToQueue = [];
    document.querySelectorAll(`.social-copy-card[data-platform="${platform}"] .post-item`).forEach(item => {
        const queueBtn = item.querySelector(`.btn-outline-success[data-platform="${platform}"]`);
        const usedBadge = item.querySelector('.used-badge');
        if (queueBtn && !queueBtn.disabled && !usedBadge) {
            postsToQueue.push({
                postId: parseInt(queueBtn.dataset.postId),
                btn: queueBtn
            });
        }
    });
    
    if (postsToQueue.length === 0) {
        showToast(`No unscheduled ${platform} posts to queue`, 'warning');
        return;
    }
    
    bootstrap.Modal.getInstance(document.getElementById('queueAllModal')).hide();
    showToast(`Adding ${postsToQueue.length} posts to ${platform} queue...`, 'info');
    
    let successCount = 0;
    let failCount = 0;
    
    for (const post of postsToQueue) {
        const formData = new FormData();
        formData.append('platform', platform);
        
        try {
            const response = await fetch(`/compose/post/${post.postId}/queue`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (response.ok && data.success) {
                successCount++;
                post.btn.innerHTML = '‚úÖ';
                post.btn.classList.remove('btn-outline-success');
                post.btn.classList.add('btn-success');
                post.btn.disabled = true;
            } else {
                failCount++;
            }
        } catch (e) {
            failCount++;
        }
    }
    
    if (failCount === 0) {
        showToast(`Added ${successCount} ${platform} posts to queue!`, 'success');
    } else {
        showToast(`Added ${successCount}, failed ${failCount}`, 'warning');
    }
}

function clearAllPosts() {
    if (!confirm('Clear ALL generated posts? This cannot be undone.')) return;
    
    fetch('/compose/clear-all', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const section = document.getElementById('saved-posts-section');
                if (section) section.remove();
                showToast(data.message, 'success');
            }
        });
}

function showToast(message, type = 'info') {
    const existingToast = document.getElementById('compose-toast');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.id = 'compose-toast';
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = '9999';
    
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning text-dark' : 'bg-info';
    const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
    
    toast.innerHTML = `
        <div class="toast show align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${icon} ${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('#compose-toast').remove()"></button>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => { if (toast.parentNode) toast.remove(); }, 3000);
}

// Post filtering functions
function applyPostFilters() {
    const usedFilter = document.getElementById('filter-used').value;
    const queuedFilter = document.getElementById('filter-queued').value;
    const platformFilter = document.getElementById('filter-platform').value;
    
    const cards = document.querySelectorAll('#saved-posts-container .social-copy-card');
    let visiblePosts = 0;
    let totalPosts = 0;
    
    cards.forEach(card => {
        const platform = card.dataset.platform;
        const posts = card.querySelectorAll('.post-item');
        let visibleInCard = 0;
        
        posts.forEach(post => {
            totalPosts++;
            let show = true;
            
            // Platform filter (card level)
            if (platformFilter && platform !== platformFilter) {
                show = false;
            }
            
            // Used filter
            if (usedFilter && show) {
                const usedBtn = post.querySelector('button[onclick*="toggleUsed"]');
                const isUsed = usedBtn && usedBtn.innerHTML.includes('‚úì');
                if (usedFilter === 'used' && !isUsed) show = false;
                if (usedFilter === 'unused' && isUsed) show = false;
            }
            
            // Queued filter
            if (queuedFilter && show) {
                const queueBtn = post.querySelector('.queue-toggle-btn');
                const isQueued = queueBtn && queueBtn.dataset.queued === 'true';
                if (queuedFilter === 'queued' && !isQueued) show = false;
                if (queuedFilter === 'not-queued' && isQueued) show = false;
            }
            
            post.style.display = show ? '' : 'none';
            if (show) {
                visiblePosts++;
                visibleInCard++;
            }
        });
        
        // Hide card if no visible posts
        card.style.display = visibleInCard > 0 ? '' : 'none';
    });
    
    // Update results count
    const resultsSpan = document.getElementById('filter-results-count');
    if (resultsSpan) {
        if (usedFilter || queuedFilter || platformFilter) {
            resultsSpan.textContent = `Showing ${visiblePosts} of ${totalPosts}`;
        } else {
            resultsSpan.textContent = '';
        }
    }
}

function clearPostFilters() {
    document.getElementById('filter-used').value = '';
    document.getElementById('filter-queued').value = '';
    document.getElementById('filter-platform').value = '';
    applyPostFilters();
}
</script>
{% endblock %}
