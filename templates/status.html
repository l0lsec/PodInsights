{% extends "base.html" %}
{% block title %}Processing Status{% endblock %}
{% block header %}Processing Status{% endblock %}
{% block content %}
<!-- Filter Bar -->
<div class="filter-bar">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">Search</label>
            <input type="text" class="form-control" name="q" value="{{ search_query }}" placeholder="Search episodes...">
        </div>
        <div class="col-md-2">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
                <option value="">All Statuses</option>
                <option value="complete" {% if filter_status == 'complete' %}selected{% endif %}>‚úÖ Complete</option>
                <option value="processing" {% if filter_status == 'processing' %}selected{% endif %}>‚è≥ Processing</option>
                <option value="queued" {% if filter_status == 'queued' %}selected{% endif %}>üìã Queued</option>
                <option value="error" {% if filter_status == 'error' %}selected{% endif %}>‚ùå Error</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Feed</label>
            <select name="feed" class="form-select">
                <option value="">All Feeds</option>
                {% for f in feeds_list %}
                <option value="{{ f.id }}" {% if filter_feed == f.id|string %}selected{% endif %}>{{ f.title[:30] }}{% if f.title|length > 30 %}...{% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-1">
            <label class="form-label">Type</label>
            <select name="type" class="form-select">
                <option value="">All</option>
                <option value="audio" {% if filter_type == 'audio' %}selected{% endif %}>üéôÔ∏è</option>
                <option value="text" {% if filter_type == 'text' %}selected{% endif %}>üìÑ</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Sort By</label>
            <select name="sort" class="form-select">
                <option value="released" {% if sort == 'released' %}selected{% endif %}>Release Date</option>
                <option value="processed" {% if sort == 'processed' %}selected{% endif %}>Processed Date</option>
            </select>
        </div>
        <div class="col-md-1">
            <label class="form-label">Order</label>
            <select name="order" class="form-select">
                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>‚Üì</option>
                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>‚Üë</option>
            </select>
        </div>
        <div class="col-md-1">
            <button type="submit" class="btn btn-secondary w-100">Go</button>
        </div>
    </form>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <span class="results-count">
        Showing <strong>{{ episodes|length }}</strong> episode{% if episodes|length != 1 %}s{% endif %}
        {% if filter_status or filter_feed or filter_type or search_query %}
        (filtered)
        <a href="{{ url_for('status_page') }}" class="ms-2 text-decoration-none">Clear filters</a>
        {% endif %}
    </span>
    <button type="button" class="btn btn-sm btn-outline-danger d-none" id="bulk-delete-btn" 
            onclick="confirmBulkDelete()">
        üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)
    </button>
</div>

{% if episodes %}
<form id="bulk-delete-form" method="post" action="{{ url_for('bulk_delete_episodes') }}">
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" class="form-check-input" id="select-all" 
                           onchange="toggleSelectAll(this)" title="Select all">
                </th>
                <th>Feed</th>
                <th>Title</th>
                <th>Type</th>
                <th>Released</th>
                <th>Processed</th>
                <th>Status</th>
                <th>Preview</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for ep in episodes %}
            {% set is_audio = ep.url.lower().endswith(('.mp3', '.m4a', '.wav', '.ogg', '.aac', '.flac')) %}
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input episode-checkbox" 
                           name="episode_ids" value="{{ ep.id }}" onchange="updateSelectedCount()">
                </td>
                <td>
                    <small>{{ feeds.get(ep.feed_id, ep.feed_id) }}</small>
                </td>
                <td>{{ ep.title }}</td>
                <td>
                    {% if is_audio %}
                    <span class="badge badge-audio">üéôÔ∏è</span>
                    {% else %}
                    <span class="badge badge-text">üìÑ</span>
                    {% endif %}
                </td>
                <td class="text-nowrap">{{ ep.published[:10] if ep.published else '‚Äî' }}</td>
                <td class="text-nowrap">{{ ep.processed_at[:10] if ep.processed_at else '‚Äî' }}</td>
                <td>
                    {% if ep.status == 'complete' %}
                    <span class="badge bg-success">Complete</span>
                    {% elif ep.status == 'processing' %}
                    <span class="badge bg-warning text-dark">Processing</span>
                    {% elif ep.status == 'error' %}
                    <span class="badge bg-danger">Error</span>
                    {% elif ep.status == 'queued' %}
                    <span class="badge bg-info">Queued</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ ep.status or 'Unknown' }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if is_audio %}
                    <audio controls preload="none" src="{{ ep.url }}" style="max-width: 180px; height: 32px;">
                        Your browser does not support the audio element.
                    </audio>
                    {% else %}
                    <a href="{{ ep.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">View Original</a>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        {% if ep.status == 'complete' %}
                        {% if is_audio %}
                        <a href="{{ url_for('process_episode', url=ep.url, title=ep.title, feed_id=ep.feed_id, published=ep.published) }}" 
                           class="btn btn-outline-primary">View</a>
                        {% else %}
                        <a href="{{ url_for('process_text_article', url=ep.url, title=ep.title, feed_id=ep.feed_id, published=ep.published) }}" 
                           class="btn btn-outline-primary">View</a>
                        {% endif %}
                        {% endif %}
                        
                        {% if ep.status in ['complete', 'error'] %}
                        <a href="{{ url_for('reprocess_episode', episode_id=ep.id) }}" 
                           class="btn btn-outline-warning"
                           onclick="return confirm('Reprocess this episode? This will regenerate the summary and action items.');"
                           data-processing="true">
                            Reprocess
                        </a>
                        {% endif %}
                        
                        <a href="{{ url_for('delete_episode', episode_id=ep.id) }}" 
                           class="btn btn-outline-danger"
                           onclick="return confirm('Delete this episode and all its associated data?');">
                            Delete
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</form>

<script>
function toggleSelectAll(checkbox) {
    const episodeCheckboxes = document.querySelectorAll('.episode-checkbox');
    episodeCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('.episode-checkbox:checked').length;
    const total = document.querySelectorAll('.episode-checkbox').length;
    document.getElementById('selected-count').textContent = checked;
    document.getElementById('bulk-delete-btn').classList.toggle('d-none', checked === 0);
    document.getElementById('select-all').checked = checked === total && total > 0;
    document.getElementById('select-all').indeterminate = checked > 0 && checked < total;
}

function confirmBulkDelete() {
    const count = document.querySelectorAll('.episode-checkbox:checked').length;
    if (count === 0) return;
    if (confirm(`Delete ${count} episode${count > 1 ? 's' : ''} and ALL their associated articles and tickets? This cannot be undone!`)) {
        document.getElementById('bulk-delete-form').submit();
    }
}
</script>
{% else %}
<div class="text-center py-5">
    <div class="display-1 mb-3">üìä</div>
    <h3>No Episodes Found</h3>
    {% if filter_status or filter_feed or filter_type or search_query %}
    <p class="text-muted">No episodes match your current filters.</p>
    {% else %}
    <p class="text-muted">No episodes queued or processed yet.</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary">Browse Feeds</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}
